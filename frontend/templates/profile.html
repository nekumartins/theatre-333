{% extends "base.html" %}

{% block title %}My Profile{% endblock %}

{% block preauth %}
<script>
    (function() {
        function isTokenValid(token) {
            if (!token) return false;
            try {
                const payload = JSON.parse(atob(token.split('.')[1]));
                const exp = payload.exp * 1000;
                return Date.now() < exp;
            } catch (e) {
                return false;
            }
        }

        const token = localStorage.getItem('access_token');
        if (!token || !isTokenValid(token)) {
            localStorage.clear();
            window.location.href = '/login';
        }
    })();
</script>
{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <h1 class="text-4xl font-bold mb-8 bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent">My Profile</h1>
    
    <div class="bg-gradient-to-br from-[#12121a] to-[#1a1a24] rounded-xl border border-purple-500/20 p-8">
        <form id="profile-form" class="space-y-6">
            <!-- Personal Information -->
            <div class="border-b border-purple-500/10 pb-6">
                <h2 class="text-2xl font-bold text-white mb-4">Personal Information</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-gray-300 font-medium mb-2">First Name</label>
                        <input type="text" id="first_name" 
                               class="w-full bg-[#0a0a0f] border border-purple-500/30 rounded-lg px-4 py-3 text-gray-300 focus:border-purple-500 focus:outline-none focus:ring-2 focus:ring-purple-500/20" 
                               required>
                    </div>
                    <div>
                        <label class="block text-gray-300 font-medium mb-2">Last Name</label>
                        <input type="text" id="last_name" 
                               class="w-full bg-[#0a0a0f] border border-purple-500/30 rounded-lg px-4 py-3 text-gray-300 focus:border-purple-500 focus:outline-none focus:ring-2 focus:ring-purple-500/20" 
                               required>
                    </div>
                    <div>
                        <label class="block text-gray-300 font-medium mb-2">Email</label>
                        <input type="email" id="email" 
                               class="w-full bg-[#0a0a0f] border border-purple-500/30 rounded-lg px-4 py-3 text-gray-400 cursor-not-allowed" 
                               disabled>
                        <p class="text-xs text-gray-500 mt-1">Email cannot be changed</p>
                    </div>
                    <div>
                        <label class="block text-gray-300 font-medium mb-2">Phone</label>
                        <input type="tel" id="phone" 
                               class="w-full bg-[#0a0a0f] border border-purple-500/30 rounded-lg px-4 py-3 text-gray-300 focus:border-purple-500 focus:outline-none focus:ring-2 focus:ring-purple-500/20">
                    </div>
                    <div>
                        <label class="block text-gray-300 font-medium mb-2">Date of Birth</label>
                        <input type="date" id="date_of_birth" 
                               class="w-full bg-[#0a0a0f] border border-purple-500/30 rounded-lg px-4 py-3 text-gray-300 focus:border-purple-500 focus:outline-none focus:ring-2 focus:ring-purple-500/20">
                    </div>
                </div>
            </div>

            <!-- Address Information -->
            <div class="border-b border-purple-500/10 pb-6">
                <h2 class="text-2xl font-bold text-white mb-4">Address</h2>
                <div class="space-y-6">
                    <div>
                        <label class="block text-gray-300 font-medium mb-2">Address Line 1</label>
                        <input type="text" id="address_line1" 
                               class="w-full bg-[#0a0a0f] border border-purple-500/30 rounded-lg px-4 py-3 text-gray-300 focus:border-purple-500 focus:outline-none focus:ring-2 focus:ring-purple-500/20">
                    </div>
                    <div>
                        <label class="block text-gray-300 font-medium mb-2">Address Line 2 (Optional)</label>
                        <input type="text" id="address_line2" 
                               class="w-full bg-[#0a0a0f] border border-purple-500/30 rounded-lg px-4 py-3 text-gray-300 focus:border-purple-500 focus:outline-none focus:ring-2 focus:ring-purple-500/20">
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div>
                            <label class="block text-gray-300 font-medium mb-2">City</label>
                            <input type="text" id="city" 
                                   class="w-full bg-[#0a0a0f] border border-purple-500/30 rounded-lg px-4 py-3 text-gray-300 focus:border-purple-500 focus:outline-none focus:ring-2 focus:ring-purple-500/20">
                        </div>
                        <div>
                            <label class="block text-gray-300 font-medium mb-2">Postal Code</label>
                            <input type="text" id="postal_code" 
                                   class="w-full bg-[#0a0a0f] border border-purple-500/30 rounded-lg px-4 py-3 text-gray-300 focus:border-purple-500 focus:outline-none focus:ring-2 focus:ring-purple-500/20">
                        </div>
                        <div>
                            <label class="block text-gray-300 font-medium mb-2">Country</label>
                            <input type="text" id="country" 
                                   class="w-full bg-[#0a0a0f] border border-purple-500/30 rounded-lg px-4 py-3 text-gray-300 focus:border-purple-500 focus:outline-none focus:ring-2 focus:ring-purple-500/20">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Account Status (Read-only) -->
            <div>
                <h2 class="text-2xl font-bold text-white mb-4">Account Information</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-gray-400 font-medium mb-2">Registration Date</label>
                        <p id="registration_date" class="text-gray-300"></p>
                    </div>
                    <div>
                        <label class="block text-gray-400 font-medium mb-2">Account Status</label>
                        <span id="account_status" class="inline-block px-3 py-1 rounded-lg text-sm font-medium"></span>
                    </div>
                    <div>
                        <label class="block text-gray-400 font-medium mb-2">Email Verified</label>
                        <span id="email_verified" class="inline-block px-3 py-1 rounded-lg text-sm font-medium"></span>
                    </div>
                </div>
            </div>

            <!-- Submit Button -->
            <div class="pt-6">
                <button type="submit" 
                        class="w-full md:w-auto px-8 py-3 bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white rounded-lg font-semibold transition-all shadow-lg shadow-purple-500/30 hover:shadow-purple-500/50">
                    Save Changes
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', async function() {
        // Check if token is valid
        function isTokenValid(token) {
            if (!token) return false;
            try {
                const payload = JSON.parse(atob(token.split('.')[1]));
                const exp = payload.exp * 1000;
                return Date.now() < exp;
            } catch (e) {
                return false;
            }
        }

        const token = localStorage.getItem('access_token');
        if (!token || !isTokenValid(token)) {
            localStorage.clear();
            alert('Your session has expired. Please login again.');
            window.location.href = '/login';
            return;
        }

        // Load profile data
        async function loadProfile() {
            console.log('Loading profile with token:', token.substring(0, 20) + '...');
            try {
                const response = await fetch('/api/profile/me', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                console.log('Profile response status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Profile error:', errorText);
                    throw new Error('Failed to load profile');
                }
                
                const profile = await response.json();
                console.log('Profile data:', profile);
                
                // Populate form fields
                document.getElementById('first_name').value = profile.first_name || '';
                document.getElementById('last_name').value = profile.last_name || '';
                document.getElementById('email').value = profile.email || '';
                document.getElementById('phone').value = profile.phone || '';
                document.getElementById('date_of_birth').value = profile.date_of_birth || '';
                document.getElementById('address_line1').value = profile.address_line1 || '';
                document.getElementById('address_line2').value = profile.address_line2 || '';
                document.getElementById('city').value = profile.city || '';
                document.getElementById('postal_code').value = profile.postal_code || '';
                document.getElementById('country').value = profile.country || '';
                
                // Display read-only fields
                document.getElementById('registration_date').textContent = 
                    new Date(profile.registration_date).toLocaleDateString();
                
                const statusEl = document.getElementById('account_status');
                statusEl.textContent = profile.account_status;
                statusEl.className = 'inline-block px-3 py-1 rounded-lg text-sm font-medium ' + 
                    (profile.account_status === 'Active' ? 'bg-green-500/10 text-green-400 border border-green-500/20' : 
                     'bg-red-500/10 text-red-400 border border-red-500/20');
                
                const verifiedEl = document.getElementById('email_verified');
                verifiedEl.textContent = profile.email_verified ? '✓ Verified' : '✗ Not Verified';
                verifiedEl.className = 'inline-block px-3 py-1 rounded-lg text-sm font-medium ' + 
                    (profile.email_verified ? 'bg-green-500/10 text-green-400 border border-green-500/20' : 
                     'bg-yellow-500/10 text-yellow-400 border border-yellow-500/20');
            } catch (error) {
                console.error('Error loading profile:', error);
                alert('Failed to load profile: ' + error.message);
            }
        }

        // Update profile
        document.getElementById('profile-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const profileData = {
                first_name: document.getElementById('first_name').value,
                last_name: document.getElementById('last_name').value,
                phone: document.getElementById('phone').value,
                date_of_birth: document.getElementById('date_of_birth').value || null,
                address_line1: document.getElementById('address_line1').value,
                address_line2: document.getElementById('address_line2').value,
                city: document.getElementById('city').value,
                postal_code: document.getElementById('postal_code').value,
                country: document.getElementById('country').value
            };
            
            try {
                const response = await fetch('/api/profile/update', {
                    method: 'PUT',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(profileData)
                });
                
                if (response.ok) {
                    // Update stored first name
                    localStorage.setItem('user_first_name', profileData.first_name);
                    alert('✓ Profile updated successfully!');
                    loadProfile(); // Reload to show updated data
                } else {
                    const error = await response.json();
                    alert('Failed to update profile: ' + (error.detail || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error updating profile:', error);
                alert('Error updating profile. Please try again.');
            }
        });

        // Load profile on page load
        await loadProfile();
    });
</script>
{% endblock %}
