{% extends "base.html" %}

{% block title %}Admin Panel - Theatre Booking System{% endblock %}

{% block preauth %}
<script>
    (function() {
        function isTokenValid(token) {
            if (!token) return false;
            try {
                const payload = JSON.parse(atob(token.split('.')[1]));
                const exp = payload.exp * 1000;
                return Date.now() < exp;
            } catch (e) {
                return false;
            }
        }

        const token = localStorage.getItem('access_token');
        const isAdmin = localStorage.getItem('is_admin') === 'true';

        if (!token || !isTokenValid(token)) {
            localStorage.clear();
            window.location.href = '/login';
        }

        if (!isAdmin) {
            // Not an admin - redirect to home
            window.location.href = '/';
        }
    })();
</script>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-[#0a0a0f] py-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Header -->
        <div class="mb-8">
            <h1 class="text-4xl font-bold bg-gradient-to-r from-purple-500 to-pink-500 bg-clip-text text-transparent">
                Admin Panel
            </h1>
            <p class="mt-2 text-gray-400">Manage shows, venues, and performances</p>
        </div>

        <!-- Stats Cards -->
        <div id="statsSection" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- Stats will be loaded here -->
        </div>

        <!-- Tab Navigation -->
        <div class="bg-[#12121a] rounded-lg p-1 mb-6 inline-flex space-x-1 flex-wrap">
            <button onclick="switchTab('shows')" id="showsTab" class="tab-btn active px-6 py-3 rounded-md transition-all">
                Shows
            </button>
            <button onclick="switchTab('venues')" id="venuesTab" class="tab-btn px-6 py-3 rounded-md transition-all">
                Venues
            </button>
            <button onclick="switchTab('performances')" id="performancesTab" class="tab-btn px-6 py-3 rounded-md transition-all">
                Performances
            </button>
            <button onclick="switchTab('pricing')" id="pricingTab" class="tab-btn px-6 py-3 rounded-md transition-all">
                Pricing
            </button>
            <button onclick="switchTab('users')" id="usersTab" class="tab-btn px-6 py-3 rounded-md transition-all">
                üë• Users
            </button>
            <button onclick="switchTab('bookings')" id="bookingsTab" class="tab-btn px-6 py-3 rounded-md transition-all">
                üé´ Bookings
            </button>
            <button onclick="switchTab('roles')" id="rolesTab" class="tab-btn px-6 py-3 rounded-md transition-all">
                üîê Roles
            </button>
            <button onclick="switchTab('auditLogs')" id="auditLogsTab" class="tab-btn px-6 py-3 rounded-md transition-all">
                üìã Audit
            </button>
            <button onclick="switchTab('analytics')" id="analyticsTab" class="tab-btn px-6 py-3 rounded-md transition-all">
                Analytics
            </button>
        </div>

        <!-- Shows Management -->
        <div id="showsSection" class="tab-content">
            <div class="bg-[#12121a] rounded-lg p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-semibold text-white">Manage Shows</h2>
                    <button onclick="openShowModal()" class="px-4 py-2 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-lg hover:opacity-90 transition-opacity">
                        + Add Show
                    </button>
                </div>
                <div id="showsList" class="space-y-4">
                    <!-- Shows will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Venues Management -->
        <div id="venuesSection" class="tab-content hidden">
            <div class="bg-[#12121a] rounded-lg p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-semibold text-white">Manage Venues</h2>
                    <button onclick="openVenueModal()" class="px-4 py-2 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-lg hover:opacity-90 transition-opacity">
                        + Add Venue
                    </button>
                </div>
                <div id="venuesList" class="space-y-4">
                    <!-- Venues will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Performances Management -->
        <div id="performancesSection" class="tab-content hidden">
            <div class="bg-[#12121a] rounded-lg p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-semibold text-white">Manage Performances</h2>
                    <button onclick="openPerformanceModal()" class="px-4 py-2 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-lg hover:opacity-90 transition-opacity">
                        + Add Performance
                    </button>
                </div>
                <div id="performancesList" class="space-y-4">
                    <!-- Performances will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Pricing Management -->
        <div id="pricingSection" class="tab-content hidden">
            <div class="bg-[#12121a] rounded-lg p-6">
                <div class="mb-6">
                    <h2 class="text-2xl font-semibold text-white mb-4">Manage Performance Pricing</h2>
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-gray-300 mb-2">Select Performance</label>
                            <select id="pricingPerformanceSelect" onchange="loadPricingForPerformance()" class="w-full px-4 py-2 bg-[#0a0a0f] border border-gray-700 rounded-lg text-white focus:border-purple-500 focus:outline-none">
                                <option value="">-- Select Performance --</option>
                            </select>
                        </div>
                        <div class="flex items-end">
                            <button onclick="openPricingModal()" id="addPricingBtn" disabled class="px-4 py-2 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-lg hover:opacity-90 transition-opacity disabled:opacity-50 disabled:cursor-not-allowed">
                                + Add Pricing
                            </button>
                        </div>
                    </div>
                </div>
                <div id="pricingList" class="space-y-4">
                    <p class="text-gray-400">Select a performance to manage pricing.</p>
                </div>
            </div>
        </div>

        <!-- Analytics Dashboard -->
        <div id="analyticsSection" class="tab-content hidden">
            <div class="space-y-6">
                <!-- Overview Cards -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6" id="analyticsOverview">
                    <!-- Will be populated -->
                </div>

                <!-- Charts Section -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Popular Shows -->
                    <div class="bg-[#12121a] rounded-lg p-6">
                        <h3 class="text-xl font-semibold text-white mb-4">Popular Shows</h3>
                        <div id="popularShows" class="space-y-3">
                            <!-- Will be populated -->
                        </div>
                    </div>

                    <!-- Payment Methods -->
                    <div class="bg-[#12121a] rounded-lg p-6">
                        <h3 class="text-xl font-semibold text-white mb-4">Payment Methods</h3>
                        <div id="paymentMethods" class="space-y-3">
                            <!-- Will be populated -->
                        </div>
                    </div>

                    <!-- Genre Performance -->
                    <div class="bg-[#12121a] rounded-lg p-6">
                        <h3 class="text-xl font-semibold text-white mb-4">Genre Performance</h3>
                        <div id="genrePerformance" class="space-y-3">
                            <!-- Will be populated -->
                        </div>
                    </div>

                    <!-- Venue Utilization -->
                    <div class="bg-[#12121a] rounded-lg p-6">
                        <h3 class="text-xl font-semibold text-white mb-4">Venue Utilization</h3>
                        <div id="venueUtilization" class="space-y-3">
                            <!-- Will be populated -->
                        </div>
                    </div>
                </div>

                <!-- Revenue by Performance -->
                <div class="bg-[#12121a] rounded-lg p-6">
                    <h3 class="text-xl font-semibold text-white mb-4">Top Revenue Performances</h3>
                    <div id="revenueByPerformance" class="overflow-x-auto">
                        <!-- Will be populated -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Users Management Section -->
        <div id="usersSection" class="tab-content hidden">
            <div class="bg-[#12121a] rounded-lg p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-semibold text-white">üë• User Management</h2>
                    <div class="flex gap-4">
                        <input type="text" id="userSearch" placeholder="Search users..." 
                               class="px-4 py-2 bg-[#0a0a0f] border border-gray-700 rounded-lg text-white focus:border-purple-500 focus:outline-none"
                               onkeyup="searchUsers()">
                        <select id="userStatusFilter" onchange="filterUsers()" class="px-4 py-2 bg-[#0a0a0f] border border-gray-700 rounded-lg text-white focus:border-purple-500 focus:outline-none">
                            <option value="">All Status</option>
                            <option value="Active">Active</option>
                            <option value="Suspended">Suspended</option>
                            <option value="Deactivated">Deactivated</option>
                        </select>
                    </div>
                </div>
                <div id="usersList" class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="text-gray-400 text-sm border-b border-gray-700">
                            <tr>
                                <th class="pb-3 px-2">User</th>
                                <th class="pb-3 px-2">Email</th>
                                <th class="pb-3 px-2">Status</th>
                                <th class="pb-3 px-2">Role</th>
                                <th class="pb-3 px-2">Bookings</th>
                                <th class="pb-3 px-2">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody" class="text-white">
                            <!-- Users will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Bookings Management Section -->
        <div id="bookingsSection" class="tab-content hidden">
            <div class="bg-[#12121a] rounded-lg p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-semibold text-white">üé´ Booking Management</h2>
                    <div class="flex gap-4">
                        <input type="text" id="bookingSearch" placeholder="Search bookings..." 
                               class="px-4 py-2 bg-[#0a0a0f] border border-gray-700 rounded-lg text-white focus:border-purple-500 focus:outline-none"
                               onkeyup="searchBookings()">
                        <select id="bookingStatusFilter" onchange="filterBookingsAdmin()" class="px-4 py-2 bg-[#0a0a0f] border border-gray-700 rounded-lg text-white focus:border-purple-500 focus:outline-none">
                            <option value="">All Status</option>
                            <option value="Pending">Pending</option>
                            <option value="Confirmed">Confirmed</option>
                            <option value="Cancelled">Cancelled</option>
                            <option value="Refunded">Refunded</option>
                        </select>
                    </div>
                </div>
                <div id="bookingsList" class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="text-gray-400 text-sm border-b border-gray-700">
                            <tr>
                                <th class="pb-3 px-2">Reference</th>
                                <th class="pb-3 px-2">Customer</th>
                                <th class="pb-3 px-2">Show</th>
                                <th class="pb-3 px-2">Date</th>
                                <th class="pb-3 px-2">Seats</th>
                                <th class="pb-3 px-2">Amount</th>
                                <th class="pb-3 px-2">Status</th>
                                <th class="pb-3 px-2">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="bookingsTableBody" class="text-white">
                            <!-- Bookings will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Roles Management Section -->
        <div id="rolesSection" class="tab-content hidden">
            <div class="bg-[#12121a] rounded-lg p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-semibold text-white">üîê Role Management</h2>
                    <button onclick="openRoleModal()" class="px-4 py-2 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-lg hover:opacity-90 transition-opacity">
                        + Add Role
                    </button>
                </div>
                <div id="rolesList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Roles will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Audit Logs Section -->
        <div id="auditLogsSection" class="tab-content hidden">
            <div class="bg-[#12121a] rounded-lg p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-semibold text-white">üìã Audit Logs</h2>
                    <div class="flex gap-4">
                        <select id="auditActionFilter" onchange="filterAuditLogs()" class="px-4 py-2 bg-[#0a0a0f] border border-gray-700 rounded-lg text-white focus:border-purple-500 focus:outline-none">
                            <option value="">All Actions</option>
                        </select>
                        <select id="auditEntityFilter" onchange="filterAuditLogs()" class="px-4 py-2 bg-[#0a0a0f] border border-gray-700 rounded-lg text-white focus:border-purple-500 focus:outline-none">
                            <option value="">All Entities</option>
                        </select>
                    </div>
                </div>
                <div id="auditLogsList" class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="text-gray-400 text-sm border-b border-gray-700">
                            <tr>
                                <th class="pb-3 px-2">Timestamp</th>
                                <th class="pb-3 px-2">User</th>
                                <th class="pb-3 px-2">Action</th>
                                <th class="pb-3 px-2">Entity</th>
                                <th class="pb-3 px-2">Details</th>
                            </tr>
                        </thead>
                        <tbody id="auditLogsTableBody" class="text-white">
                            <!-- Audit logs will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- User Edit Modal -->
<div id="userModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-[#12121a] rounded-lg p-8 max-w-md w-full mx-4">
        <h3 class="text-2xl font-bold text-white mb-6">Edit User</h3>
        <form id="userForm" class="space-y-4">
            <input type="hidden" id="editUserId">
            <div>
                <label class="block text-gray-300 mb-2">Name</label>
                <p id="editUserName" class="text-white text-lg"></p>
            </div>
            <div>
                <label class="block text-gray-300 mb-2">Email</label>
                <p id="editUserEmail" class="text-white"></p>
            </div>
            <div>
                <label class="block text-gray-300 mb-2">Account Status</label>
                <select id="editUserStatus" class="w-full px-4 py-2 bg-[#0a0a0f] border border-gray-700 rounded-lg text-white focus:border-purple-500 focus:outline-none">
                    <option value="Active">Active</option>
                    <option value="Suspended">Suspended</option>
                    <option value="Deactivated">Deactivated</option>
                </select>
            </div>
            <div>
                <label class="block text-gray-300 mb-2">Role</label>
                <select id="editUserRole" class="w-full px-4 py-2 bg-[#0a0a0f] border border-gray-700 rounded-lg text-white focus:border-purple-500 focus:outline-none">
                    <option value="">No Role</option>
                </select>
            </div>
            <div>
                <label class="flex items-center space-x-2 text-gray-300">
                    <input type="checkbox" id="editUserAdmin" class="rounded">
                    <span>Admin Access</span>
                </label>
            </div>
            <div class="flex space-x-4 pt-4">
                <button type="button" onclick="closeUserModal()" class="flex-1 px-4 py-2 bg-gray-700 text-white rounded-lg hover:bg-gray-600 transition-colors">
                    Cancel
                </button>
                <button type="submit" class="flex-1 px-4 py-2 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-lg hover:opacity-90 transition-opacity">
                    Save Changes
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Role Modal -->
<div id="roleModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-[#12121a] rounded-lg p-8 max-w-lg w-full mx-4 max-h-[90vh] overflow-y-auto">
        <h3 id="roleModalTitle" class="text-2xl font-bold text-white mb-6">Add Role</h3>
        <form id="roleForm" class="space-y-4">
            <input type="hidden" id="roleId">
            <div>
                <label class="block text-gray-300 mb-2">Role Name *</label>
                <input type="text" id="roleName" required class="w-full px-4 py-2 bg-[#0a0a0f] border border-gray-700 rounded-lg text-white focus:border-purple-500 focus:outline-none">
            </div>
            <div>
                <label class="block text-gray-300 mb-2">Description</label>
                <textarea id="roleDescription" rows="2" class="w-full px-4 py-2 bg-[#0a0a0f] border border-gray-700 rounded-lg text-white focus:border-purple-500 focus:outline-none"></textarea>
            </div>
            <div class="border-t border-gray-700 pt-4">
                <label class="block text-gray-300 mb-3">Permissions</label>
                <div class="grid grid-cols-2 gap-3">
                    <label class="flex items-center space-x-2 text-gray-300">
                        <input type="checkbox" id="permManageShows" class="rounded">
                        <span>Manage Shows</span>
                    </label>
                    <label class="flex items-center space-x-2 text-gray-300">
                        <input type="checkbox" id="permManageVenues" class="rounded">
                        <span>Manage Venues</span>
                    </label>
                    <label class="flex items-center space-x-2 text-gray-300">
                        <input type="checkbox" id="permManagePerformances" class="rounded">
                        <span>Manage Performances</span>
                    </label>
                    <label class="flex items-center space-x-2 text-gray-300">
                        <input type="checkbox" id="permManageBookings" class="rounded">
                        <span>Manage Bookings</span>
                    </label>
                    <label class="flex items-center space-x-2 text-gray-300">
                        <input type="checkbox" id="permViewAnalytics" class="rounded">
                        <span>View Analytics</span>
                    </label>
                    <label class="flex items-center space-x-2 text-gray-300">
                        <input type="checkbox" id="permManageUsers" class="rounded">
                        <span>Manage Users</span>
                    </label>
                    <label class="flex items-center space-x-2 text-gray-300">
                        <input type="checkbox" id="permManagePricing" class="rounded">
                        <span>Manage Pricing</span>
                    </label>
                    <label class="flex items-center space-x-2 text-gray-300">
                        <input type="checkbox" id="permIssueRefunds" class="rounded">
                        <span>Issue Refunds</span>
                    </label>
                </div>
            </div>
            <div class="flex space-x-4 pt-4">
                <button type="button" onclick="closeRoleModal()" class="flex-1 px-4 py-2 bg-gray-700 text-white rounded-lg hover:bg-gray-600 transition-colors">
                    Cancel
                </button>
                <button type="submit" class="flex-1 px-4 py-2 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-lg hover:opacity-90 transition-opacity">
                    Save Role
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Refund Modal -->
<div id="refundModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-[#12121a] rounded-lg p-8 max-w-md w-full mx-4">
        <h3 class="text-2xl font-bold text-white mb-6">Issue Refund</h3>
        <form id="refundForm" class="space-y-4">
            <input type="hidden" id="refundBookingId">
            <div>
                <label class="block text-gray-300 mb-2">Booking Reference</label>
                <p id="refundBookingRef" class="text-white text-lg font-mono"></p>
            </div>
            <div>
                <label class="block text-gray-300 mb-2">Original Amount</label>
                <p id="refundOriginalAmount" class="text-white text-lg"></p>
            </div>
            <div>
                <label class="block text-gray-300 mb-2">Refund Amount</label>
                <input type="number" id="refundAmount" step="0.01" class="w-full px-4 py-2 bg-[#0a0a0f] border border-gray-700 rounded-lg text-white focus:border-purple-500 focus:outline-none">
                <p class="text-gray-500 text-sm mt-1">Leave empty for full refund</p>
            </div>
            <div>
                <label class="block text-gray-300 mb-2">Reason *</label>
                <textarea id="refundReason" required rows="3" class="w-full px-4 py-2 bg-[#0a0a0f] border border-gray-700 rounded-lg text-white focus:border-purple-500 focus:outline-none"></textarea>
            </div>
            <div class="flex space-x-4 pt-4">
                <button type="button" onclick="closeRefundModal()" class="flex-1 px-4 py-2 bg-gray-700 text-white rounded-lg hover:bg-gray-600 transition-colors">
                    Cancel
                </button>
                <button type="submit" class="flex-1 px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors">
                    Issue Refund
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Show Modal -->
<div id="showModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-[#12121a] rounded-lg p-8 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
        <h3 id="showModalTitle" class="text-2xl font-bold text-white mb-6">Add Show</h3>
        <form id="showForm" class="space-y-4">
            <input type="hidden" id="showId">
            <div class="grid grid-cols-2 gap-4">
                <div class="col-span-2">
                    <label class="block text-gray-300 mb-2">Title *</label>
                    <input type="text" id="showTitle" required class="w-full px-4 py-2 bg-[#0a0a0f] border border-gray-700 rounded-lg text-white focus:border-purple-500 focus:outline-none">
                </div>
                <div class="col-span-2">
                    <label class="block text-gray-300 mb-2">Description</label>
                    <textarea id="showDescription" rows="3" class="w-full px-4 py-2 bg-[#0a0a0f] border border-gray-700 rounded-lg text-white focus:border-purple-500 focus:outline-none"></textarea>
                </div>
                <div>
                    <label class="block text-gray-300 mb-2">Genre *</label>
                    <select id="showGenre" required class="w-full px-4 py-2 bg-[#0a0a0f] border border-gray-700 rounded-lg text-white focus:border-purple-500 focus:outline-none">
                        <!-- Will be populated dynamically -->
                    </select>
                </div>
                <div>
                    <label class="block text-gray-300 mb-2">Duration (minutes) *</label>
                    <input type="number" id="showDuration" required class="w-full px-4 py-2 bg-[#0a0a0f] border border-gray-700 rounded-lg text-white focus:border-purple-500 focus:outline-none">
                </div>
                <div>
                    <label class="block text-gray-300 mb-2">Language</label>
                    <input type="text" id="showLanguage" class="w-full px-4 py-2 bg-[#0a0a0f] border border-gray-700 rounded-lg text-white focus:border-purple-500 focus:outline-none">
                </div>
                <div>
                    <label class="block text-gray-300 mb-2">Age Rating</label>
                    <input type="text" id="showAgeRating" class="w-full px-4 py-2 bg-[#0a0a0f] border border-gray-700 rounded-lg text-white focus:border-purple-500 focus:outline-none">
                </div>
                <div>
                    <label class="block text-gray-300 mb-2">Producer</label>
                    <input type="text" id="showProducer" class="w-full px-4 py-2 bg-[#0a0a0f] border border-gray-700 rounded-lg text-white focus:border-purple-500 focus:outline-none">
                </div>
                <div>
                    <label class="block text-gray-300 mb-2">Director</label>
                    <input type="text" id="showDirector" class="w-full px-4 py-2 bg-[#0a0a0f] border border-gray-700 rounded-lg text-white focus:border-purple-500 focus:outline-none">
                </div>
                <div class="col-span-2">
                    <label class="block text-gray-300 mb-2">Poster URL</label>
                    <input type="url" id="showPosterUrl" class="w-full px-4 py-2 bg-[#0a0a0f] border border-gray-700 rounded-lg text-white focus:border-purple-500 focus:outline-none">
                </div>
                <div>
                    <label class="block text-gray-300 mb-2">Status</label>
                    <select id="showStatus" class="w-full px-4 py-2 bg-[#0a0a0f] border border-gray-700 rounded-lg text-white focus:border-purple-500 focus:outline-none">
                        <option value="Active">Active</option>
                        <option value="Inactive">Inactive</option>
                    </select>
                </div>
            </div>
            <div class="flex justify-end space-x-4 mt-6">
                <button type="button" onclick="closeShowModal()" class="px-6 py-2 bg-gray-700 text-white rounded-lg hover:bg-gray-600 transition-colors">
                    Cancel
                </button>
                <button type="submit" class="px-6 py-2 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-lg hover:opacity-90 transition-opacity">
                    Save
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Venue Modal -->
<div id="venueModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-[#12121a] rounded-lg p-8 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
        <h3 id="venueModalTitle" class="text-2xl font-bold text-white mb-6">Add Venue</h3>
        <form id="venueForm" class="space-y-4">
            <input type="hidden" id="venueId">
            <div class="grid grid-cols-2 gap-4">
                <div class="col-span-2">
                    <label class="block text-gray-300 mb-2">Venue Name *</label>
                    <input type="text" id="venueName" required class="w-full px-4 py-2 bg-[#0a0a0f] border border-gray-700 rounded-lg text-white focus:border-purple-500 focus:outline-none">
                </div>
                <div class="col-span-2">
                    <label class="block text-gray-300 mb-2">Address Line 1 *</label>
                    <input type="text" id="venueAddress1" required class="w-full px-4 py-2 bg-[#0a0a0f] border border-gray-700 rounded-lg text-white focus:border-purple-500 focus:outline-none">
                </div>
                <div class="col-span-2">
                    <label class="block text-gray-300 mb-2">Address Line 2</label>
                    <input type="text" id="venueAddress2" class="w-full px-4 py-2 bg-[#0a0a0f] border border-gray-700 rounded-lg text-white focus:border-purple-500 focus:outline-none">
                </div>
                <div>
                    <label class="block text-gray-300 mb-2">City *</label>
                    <input type="text" id="venueCity" required class="w-full px-4 py-2 bg-[#0a0a0f] border border-gray-700 rounded-lg text-white focus:border-purple-500 focus:outline-none">
                </div>
                <div>
                    <label class="block text-gray-300 mb-2">Postal Code</label>
                    <input type="text" id="venuePostalCode" class="w-full px-4 py-2 bg-[#0a0a0f] border border-gray-700 rounded-lg text-white focus:border-purple-500 focus:outline-none">
                </div>
                <div>
                    <label class="block text-gray-300 mb-2">Country *</label>
                    <input type="text" id="venueCountry" required class="w-full px-4 py-2 bg-[#0a0a0f] border border-gray-700 rounded-lg text-white focus:border-purple-500 focus:outline-none">
                </div>
                <div>
                    <label class="block text-gray-300 mb-2">Total Capacity *</label>
                    <input type="number" id="venueTotalCapacity" required class="w-full px-4 py-2 bg-[#0a0a0f] border border-gray-700 rounded-lg text-white focus:border-purple-500 focus:outline-none">
                </div>
                <div class="col-span-2">
                    <label class="block text-gray-300 mb-2">Phone</label>
                    <input type="tel" id="venuePhone" class="w-full px-4 py-2 bg-[#0a0a0f] border border-gray-700 rounded-lg text-white focus:border-purple-500 focus:outline-none">
                </div>
                <div class="col-span-2">
                    <label class="block text-gray-300 mb-2">Facilities (comma-separated)</label>
                    <textarea id="venueFacilities" rows="2" placeholder="e.g., Parking, Wheelchair Access, Cafe, Gift Shop" class="w-full px-4 py-2 bg-[#0a0a0f] border border-gray-700 rounded-lg text-white focus:border-purple-500 focus:outline-none"></textarea>
                </div>
            </div>
            <div class="flex justify-end space-x-4 mt-6">
                <button type="button" onclick="closeVenueModal()" class="px-6 py-2 bg-gray-700 text-white rounded-lg hover:bg-gray-600 transition-colors">
                    Cancel
                </button>
                <button type="submit" class="px-6 py-2 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-lg hover:opacity-90 transition-opacity">
                    Save
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Performance Modal -->
<div id="performanceModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-[#12121a] rounded-lg p-8 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
        <h3 id="performanceModalTitle" class="text-2xl font-bold text-white mb-6">Add Performance</h3>
        <form id="performanceForm" class="space-y-4">
            <input type="hidden" id="performanceId">
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-gray-300 mb-2">Show *</label>
                    <select id="performanceShow" required class="w-full px-4 py-2 bg-[#0a0a0f] border border-gray-700 rounded-lg text-white focus:border-purple-500 focus:outline-none">
                        <!-- Will be populated dynamically -->
                    </select>
                </div>
                <div>
                    <label class="block text-gray-300 mb-2">Venue *</label>
                    <select id="performanceVenue" required class="w-full px-4 py-2 bg-[#0a0a0f] border border-gray-700 rounded-lg text-white focus:border-purple-500 focus:outline-none">
                        <!-- Will be populated dynamically -->
                    </select>
                </div>
                <div>
                    <label class="block text-gray-300 mb-2">Date *</label>
                    <input type="date" id="performanceDate" required class="w-full px-4 py-2 bg-[#0a0a0f] border border-gray-700 rounded-lg text-white focus:border-purple-500 focus:outline-none">
                </div>
                <div>
                    <label class="block text-gray-300 mb-2">Start Time *</label>
                    <input type="time" id="performanceStartTime" required class="w-full px-4 py-2 bg-[#0a0a0f] border border-gray-700 rounded-lg text-white focus:border-purple-500 focus:outline-none">
                </div>
                <div>
                    <label class="block text-gray-300 mb-2">End Time</label>
                    <input type="time" id="performanceEndTime" class="w-full px-4 py-2 bg-[#0a0a0f] border border-gray-700 rounded-lg text-white focus:border-purple-500 focus:outline-none">
                </div>
                <div>
                    <label class="block text-gray-300 mb-2">Total Seats *</label>
                    <input type="number" id="performanceTotalSeats" required class="w-full px-4 py-2 bg-[#0a0a0f] border border-gray-700 rounded-lg text-white focus:border-purple-500 focus:outline-none">
                </div>
                <div>
                    <label class="block text-gray-300 mb-2">Available Seats *</label>
                    <input type="number" id="performanceAvailableSeats" required class="w-full px-4 py-2 bg-[#0a0a0f] border border-gray-700 rounded-lg text-white focus:border-purple-500 focus:outline-none">
                </div>
                <div>
                    <label class="block text-gray-300 mb-2">Status</label>
                    <select id="performanceStatus" class="w-full px-4 py-2 bg-[#0a0a0f] border border-gray-700 rounded-lg text-white focus:border-purple-500 focus:outline-none">
                        <option value="Scheduled">Scheduled</option>
                        <option value="Cancelled">Cancelled</option>
                        <option value="Completed">Completed</option>
                    </select>
                </div>
                <div class="col-span-2">
                    <label class="block text-gray-300 mb-2">Special Notes</label>
                    <textarea id="performanceNotes" rows="2" class="w-full px-4 py-2 bg-[#0a0a0f] border border-gray-700 rounded-lg text-white focus:border-purple-500 focus:outline-none"></textarea>
                </div>
            </div>
            <div class="flex justify-end space-x-4 mt-6">
                <button type="button" onclick="closePerformanceModal()" class="px-6 py-2 bg-gray-700 text-white rounded-lg hover:bg-gray-600 transition-colors">
                    Cancel
                </button>
                <button type="submit" class="px-6 py-2 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-lg hover:opacity-90 transition-opacity">
                    Save
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Pricing Modal -->
<div id="pricingModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-[#12121a] rounded-lg p-8 max-w-md w-full mx-4">
        <h3 id="pricingModalTitle" class="text-2xl font-bold text-white mb-6">Add Pricing</h3>
        <form id="pricingForm" class="space-y-4">
            <input type="hidden" id="pricingId">
            <input type="hidden" id="pricingPerformanceId">
            <div>
                <label class="block text-gray-300 mb-2">Seat Category *</label>
                <select id="pricingCategory" required class="w-full px-4 py-2 bg-[#0a0a0f] border border-gray-700 rounded-lg text-white focus:border-purple-500 focus:outline-none">
                    <option value="VIP">VIP</option>
                    <option value="Premium">Premium</option>
                    <option value="Standard">Standard</option>
                    <option value="Economy">Economy</option>
                </select>
            </div>
            <div>
                <label class="block text-gray-300 mb-2">Price *</label>
                <input type="number" step="0.01" min="0" id="pricingPrice" required class="w-full px-4 py-2 bg-[#0a0a0f] border border-gray-700 rounded-lg text-white focus:border-purple-500 focus:outline-none">
            </div>
            <div class="flex justify-end space-x-4 mt-6">
                <button type="button" onclick="closePricingModal()" class="px-6 py-2 bg-gray-700 text-white rounded-lg hover:bg-gray-600 transition-colors">
                    Cancel
                </button>
                <button type="submit" class="px-6 py-2 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-lg hover:opacity-90 transition-opacity">
                    Save
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    // Check admin access
    function checkAdminAccess() {
        const token = localStorage.getItem('access_token');
        const isAdmin = localStorage.getItem('is_admin') === 'true';
        
        if (!token || !isTokenValid(token)) {
            window.location.href = '/login';
            return false;
        }
        
        if (!isAdmin) {
            alert('Access denied. Admin privileges required.');
            window.location.href = '/';
            return false;
        }
        
        return true;
    }

    function isTokenValid(token) {
        try {
            const payload = JSON.parse(atob(token.split('.')[1]));
            return payload.exp * 1000 > Date.now();
        } catch {
            return false;
        }
    }

    // Tab switching
    function switchTab(tab) {
        // Hide all tab contents
        document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        
        // Show selected tab
        document.getElementById(`${tab}Section`).classList.remove('hidden');
        document.getElementById(`${tab}Tab`).classList.add('active');
        
        // Load data for the tab
        if (tab === 'shows') loadShows();
        else if (tab === 'venues') loadVenues();
        else if (tab === 'performances') loadPerformances();
        else if (tab === 'pricing') loadPerformancesForPricing();
        else if (tab === 'analytics') loadAnalytics();
        else if (tab === 'users') loadUsers();
        else if (tab === 'bookings') loadAdminBookings();
        else if (tab === 'roles') loadRoles();
        else if (tab === 'auditLogs') loadAuditLogs();
    }

    // Load stats
    async function loadStats() {
        const token = localStorage.getItem('access_token');
        
        try {
            const response = await fetch('/api/admin/stats', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            if (response.ok) {
                const stats = await response.json();
                document.getElementById('statsSection').innerHTML = `
                    <div class="bg-[#12121a] rounded-lg p-6">
                        <div class="text-gray-400 text-sm mb-2">Total Shows</div>
                        <div class="text-3xl font-bold text-white">${stats.shows.total}</div>
                        <div class="text-green-500 text-sm mt-1">${stats.shows.active} active</div>
                    </div>
                    <div class="bg-[#12121a] rounded-lg p-6">
                        <div class="text-gray-400 text-sm mb-2">Total Venues</div>
                        <div class="text-3xl font-bold text-white">${stats.venues.total}</div>
                    </div>
                    <div class="bg-[#12121a] rounded-lg p-6">
                        <div class="text-gray-400 text-sm mb-2">Performances</div>
                        <div class="text-3xl font-bold text-white">${stats.performances.total}</div>
                        <div class="text-purple-500 text-sm mt-1">${stats.performances.upcoming} upcoming</div>
                    </div>
                    <div class="bg-[#12121a] rounded-lg p-6">
                        <div class="text-gray-400 text-sm mb-2">Total Bookings</div>
                        <div class="text-3xl font-bold text-white">${stats.bookings.total}</div>
                        <div class="text-green-500 text-sm mt-1">${stats.bookings.confirmed} confirmed</div>
                    </div>
                `;
            }
        } catch (error) {
            console.error('Error loading stats:', error);
        }
    }

    // Load shows
    async function loadShows() {
        try {
            const response = await fetch('/api/shows/?status=All');
            if (response.ok) {
                const shows = await response.json();
                const showsList = document.getElementById('showsList');
                
                if (shows.length === 0) {
                    showsList.innerHTML = '<p class="text-gray-400">No shows found.</p>';
                    return;
                }
                
                showsList.innerHTML = shows.map(show => `
                    <div class="bg-[#0a0a0f] rounded-lg p-4 flex justify-between items-center">
                        <div>
                            <h3 class="text-white font-semibold text-lg">${show.title}</h3>
                            <p class="text-gray-400 text-sm mt-1">${show.genre_name || 'N/A'} ‚Ä¢ ${show.duration_minutes} min</p>
                            <div class="mt-2">
                                <span class="px-2 py-1 text-xs rounded ${show.show_status === 'Active' ? 'bg-green-500/20 text-green-500' : 'bg-gray-500/20 text-gray-500'}">
                                    ${show.show_status}
                                </span>
                            </div>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick='editShow(${JSON.stringify(show)})' class="px-4 py-2 bg-purple-500 text-white rounded hover:bg-purple-600 transition-colors">
                                Edit
                            </button>
                            <button onclick="deleteShow(${show.show_id})" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 transition-colors">
                                Delete
                            </button>
                        </div>
                    </div>
                `).join('');
            }
        } catch (error) {
            console.error('Error loading shows:', error);
        }
    }

    // Load venues
    async function loadVenues() {
        try {
            const response = await fetch('/api/shows/venues/');
            if (response.ok) {
                const venues = await response.json();
                const venuesList = document.getElementById('venuesList');
                
                if (venues.length === 0) {
                    venuesList.innerHTML = '<p class="text-gray-400">No venues found.</p>';
                    return;
                }
                
                venuesList.innerHTML = venues.map(venue => `
                    <div class="bg-[#0a0a0f] rounded-lg p-4 flex justify-between items-center">
                        <div>
                            <h3 class="text-white font-semibold text-lg">${venue.venue_name}</h3>
                            <p class="text-gray-400 text-sm mt-1">${venue.city}, ${venue.country}</p>
                            <p class="text-gray-500 text-sm mt-1">Capacity: ${venue.total_capacity}</p>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick='editVenue(${JSON.stringify(venue)})' class="px-4 py-2 bg-purple-500 text-white rounded hover:bg-purple-600 transition-colors">
                                Edit
                            </button>
                            <button onclick="deleteVenue(${venue.venue_id})" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 transition-colors">
                                Delete
                            </button>
                        </div>
                    </div>
                `).join('');
            }
        } catch (error) {
            console.error('Error loading venues:', error);
        }
    }

    // Load performances
    async function loadPerformances() {
        try {
            const response = await fetch('/api/performances/');
            if (response.ok) {
                const performances = await response.json();
                const performancesList = document.getElementById('performancesList');
                
                if (performances.length === 0) {
                    performancesList.innerHTML = '<p class="text-gray-400">No performances found.</p>';
                    return;
                }
                
                performancesList.innerHTML = performances.map(perf => `
                    <div class="bg-[#0a0a0f] rounded-lg p-4 flex justify-between items-center">
                        <div>
                            <h3 class="text-white font-semibold text-lg">${perf.show_title || 'Unknown Show'}</h3>
                            <p class="text-gray-400 text-sm mt-1">${perf.venue_name || 'Unknown Venue'}</p>
                            <p class="text-gray-500 text-sm mt-1">${perf.performance_date} at ${perf.start_time}</p>
                            <div class="mt-2">
                                <span class="px-2 py-1 text-xs rounded ${perf.performance_status === 'Scheduled' ? 'bg-blue-500/20 text-blue-500' : 'bg-gray-500/20 text-gray-500'}">
                                    ${perf.performance_status}
                                </span>
                            </div>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick='editPerformance(${JSON.stringify(perf)})' class="px-4 py-2 bg-purple-500 text-white rounded hover:bg-purple-600 transition-colors">
                                Edit
                            </button>
                            <button onclick="deletePerformance(${perf.performance_id})" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 transition-colors">
                                Delete
                            </button>
                        </div>
                    </div>
                `).join('');
            }
        } catch (error) {
            console.error('Error loading performances:', error);
        }
    }

    // Show modals
    function openShowModal() {
        document.getElementById('showModalTitle').textContent = 'Add Show';
        document.getElementById('showForm').reset();
        document.getElementById('showId').value = '';
        loadGenres();
        document.getElementById('showModal').classList.remove('hidden');
        document.getElementById('showModal').classList.add('flex');
    }

    function closeShowModal() {
        document.getElementById('showModal').classList.add('hidden');
        document.getElementById('showModal').classList.remove('flex');
    }

    function editShow(show) {
        document.getElementById('showModalTitle').textContent = 'Edit Show';
        document.getElementById('showId').value = show.show_id;
        document.getElementById('showTitle').value = show.title;
        document.getElementById('showDescription').value = show.description || '';
        document.getElementById('showDuration').value = show.duration_minutes;
        document.getElementById('showLanguage').value = show.language || '';
        document.getElementById('showAgeRating').value = show.age_rating || '';
        document.getElementById('showProducer').value = show.producer || '';
        document.getElementById('showDirector').value = show.director || '';
        document.getElementById('showPosterUrl').value = show.poster_url || '';
        document.getElementById('showStatus').value = show.show_status;
        
        loadGenres().then(() => {
            document.getElementById('showGenre').value = show.genre_id;
        });
        
        document.getElementById('showModal').classList.remove('hidden');
        document.getElementById('showModal').classList.add('flex');
    }

    async function loadGenres() {
        try {
            const response = await fetch('/api/shows/genres/');
            if (response.ok) {
                const genres = await response.json();
                const select = document.getElementById('showGenre');
                select.innerHTML = genres.map(g => `<option value="${g.genre_id}">${g.genre_name}</option>`).join('');
            }
        } catch (error) {
            console.error('Error loading genres:', error);
        }
    }

    // Venue modals
    function openVenueModal() {
        document.getElementById('venueModalTitle').textContent = 'Add Venue';
        document.getElementById('venueForm').reset();
        document.getElementById('venueId').value = '';
        document.getElementById('venueModal').classList.remove('hidden');
        document.getElementById('venueModal').classList.add('flex');
    }

    function closeVenueModal() {
        document.getElementById('venueModal').classList.add('hidden');
        document.getElementById('venueModal').classList.remove('flex');
    }

    function editVenue(venue) {
        document.getElementById('venueModalTitle').textContent = 'Edit Venue';
        document.getElementById('venueId').value = venue.venue_id;
        document.getElementById('venueName').value = venue.venue_name;
        document.getElementById('venueAddress1').value = venue.address_line1;
        document.getElementById('venueAddress2').value = venue.address_line2 || '';
        document.getElementById('venueCity').value = venue.city;
        document.getElementById('venuePostalCode').value = venue.postal_code || '';
        document.getElementById('venueCountry').value = venue.country;
        document.getElementById('venueTotalCapacity').value = venue.total_capacity;
        document.getElementById('venuePhone').value = venue.phone || '';
        document.getElementById('venueFacilities').value = venue.facilities || '';
        
        document.getElementById('venueModal').classList.remove('hidden');
        document.getElementById('venueModal').classList.add('flex');
    }

    // Performance modals
    function openPerformanceModal() {
        document.getElementById('performanceModalTitle').textContent = 'Add Performance';
        document.getElementById('performanceForm').reset();
        document.getElementById('performanceId').value = '';
        loadShowsForPerformance();
        loadVenuesForPerformance();
        document.getElementById('performanceModal').classList.remove('hidden');
        document.getElementById('performanceModal').classList.add('flex');
    }

    function closePerformanceModal() {
        document.getElementById('performanceModal').classList.add('hidden');
        document.getElementById('performanceModal').classList.remove('flex');
    }

    function editPerformance(perf) {
        document.getElementById('performanceModalTitle').textContent = 'Edit Performance';
        document.getElementById('performanceId').value = perf.performance_id;
        document.getElementById('performanceDate').value = perf.performance_date;
        document.getElementById('performanceStartTime').value = perf.start_time;
        document.getElementById('performanceEndTime').value = perf.end_time || '';
        document.getElementById('performanceTotalSeats').value = perf.total_seats;
        document.getElementById('performanceAvailableSeats').value = perf.available_seats;
        document.getElementById('performanceStatus').value = perf.performance_status;
        document.getElementById('performanceNotes').value = perf.special_notes || '';
        
        Promise.all([loadShowsForPerformance(), loadVenuesForPerformance()]).then(() => {
            document.getElementById('performanceShow').value = perf.show_id;
            document.getElementById('performanceVenue').value = perf.venue_id;
        });
        
        document.getElementById('performanceModal').classList.remove('hidden');
        document.getElementById('performanceModal').classList.add('flex');
    }

    async function loadShowsForPerformance() {
        try {
            const response = await fetch('/api/shows/?status=Active');
            if (response.ok) {
                const shows = await response.json();
                const select = document.getElementById('performanceShow');
                select.innerHTML = shows.map(s => `<option value="${s.show_id}">${s.title}</option>`).join('');
            }
        } catch (error) {
            console.error('Error loading shows:', error);
        }
    }

    async function loadVenuesForPerformance() {
        try {
            const response = await fetch('/api/shows/venues/');
            if (response.ok) {
                const venues = await response.json();
                const select = document.getElementById('performanceVenue');
                select.innerHTML = venues.map(v => `<option value="${v.venue_id}">${v.venue_name}</option>`).join('');
            }
        } catch (error) {
            console.error('Error loading venues:', error);
        }
    }

    // Form submissions
    document.getElementById('showForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const token = localStorage.getItem('token');
        const showId = document.getElementById('showId').value;
        
        const data = {
            title: document.getElementById('showTitle').value,
            description: document.getElementById('showDescription').value || null,
            genre_id: parseInt(document.getElementById('showGenre').value),
            duration_minutes: parseInt(document.getElementById('showDuration').value),
            language: document.getElementById('showLanguage').value || null,
            age_rating: document.getElementById('showAgeRating').value || null,
            producer: document.getElementById('showProducer').value || null,
            director: document.getElementById('showDirector').value || null,
            poster_url: document.getElementById('showPosterUrl').value || null,
            show_status: document.getElementById('showStatus').value
        };
        
        try {
            const response = await fetch(showId ? `/api/admin/shows/${showId}` : '/api/admin/shows', {
                method: showId ? 'PUT' : 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(data)
            });
            
            if (response.ok) {
                closeShowModal();
                loadShows();
                loadStats();
                alert(showId ? 'Show updated successfully!' : 'Show created successfully!');
            } else {
                const error = await response.json();
                alert(error.detail || 'Failed to save show');
            }
        } catch (error) {
            console.error('Error saving show:', error);
            alert('Failed to save show');
        }
    });

    document.getElementById('venueForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const token = localStorage.getItem('token');
        const venueId = document.getElementById('venueId').value;
        
        const data = {
            venue_name: document.getElementById('venueName').value,
            address_line1: document.getElementById('venueAddress1').value,
            address_line2: document.getElementById('venueAddress2').value || null,
            city: document.getElementById('venueCity').value,
            postal_code: document.getElementById('venuePostalCode').value || null,
            country: document.getElementById('venueCountry').value,
            total_capacity: parseInt(document.getElementById('venueTotalCapacity').value),
            phone: document.getElementById('venuePhone').value || null,
            facilities: document.getElementById('venueFacilities').value || null
        };
        
        try {
            const response = await fetch(venueId ? `/api/admin/venues/${venueId}` : '/api/admin/venues', {
                method: venueId ? 'PUT' : 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(data)
            });
            
            if (response.ok) {
                closeVenueModal();
                loadVenues();
                loadStats();
                alert(venueId ? 'Venue updated successfully!' : 'Venue created successfully!');
            } else {
                const error = await response.json();
                alert(error.detail || 'Failed to save venue');
            }
        } catch (error) {
            console.error('Error saving venue:', error);
            alert('Failed to save venue');
        }
    });

    document.getElementById('performanceForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const token = localStorage.getItem('token');
        const performanceId = document.getElementById('performanceId').value;
        
        const data = {
            show_id: parseInt(document.getElementById('performanceShow').value),
            venue_id: parseInt(document.getElementById('performanceVenue').value),
            performance_date: document.getElementById('performanceDate').value,
            start_time: document.getElementById('performanceStartTime').value,
            end_time: document.getElementById('performanceEndTime').value || null,
            total_seats: parseInt(document.getElementById('performanceTotalSeats').value),
            available_seats: parseInt(document.getElementById('performanceAvailableSeats').value),
            performance_status: document.getElementById('performanceStatus').value,
            special_notes: document.getElementById('performanceNotes').value || null
        };
        
        try {
            const response = await fetch(performanceId ? `/api/admin/performances/${performanceId}` : '/api/admin/performances', {
                method: performanceId ? 'PUT' : 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(data)
            });
            
            if (response.ok) {
                closePerformanceModal();
                loadPerformances();
                loadStats();
                alert(performanceId ? 'Performance updated successfully!' : 'Performance created successfully!');
            } else {
                const error = await response.json();
                alert(error.detail || 'Failed to save performance');
            }
        } catch (error) {
            console.error('Error saving performance:', error);
            alert('Failed to save performance');
        }
    });

    // Delete functions
    async function deleteShow(showId) {
        if (!confirm('Are you sure you want to delete this show?')) return;
        
        const token = localStorage.getItem('token');
        
        try {
            const response = await fetch(`/api/admin/shows/${showId}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            if (response.ok) {
                loadShows();
                loadStats();
                alert('Show deleted successfully!');
            } else {
                const error = await response.json();
                alert(error.detail || 'Failed to delete show');
            }
        } catch (error) {
            console.error('Error deleting show:', error);
            alert('Failed to delete show');
        }
    }

    async function deleteVenue(venueId) {
        if (!confirm('Are you sure you want to delete this venue?')) return;
        
        const token = localStorage.getItem('token');
        
        try {
            const response = await fetch(`/api/admin/venues/${venueId}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            if (response.ok) {
                loadVenues();
                loadStats();
                alert('Venue deleted successfully!');
            } else {
                const error = await response.json();
                alert(error.detail || 'Failed to delete venue');
            }
        } catch (error) {
            console.error('Error deleting venue:', error);
            alert('Failed to delete venue');
        }
    }

    async function deletePerformance(performanceId) {
        if (!confirm('Are you sure you want to delete this performance?')) return;
        
        const token = localStorage.getItem('token');
        
        try {
            const response = await fetch(`/api/admin/performances/${performanceId}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            if (response.ok) {
                loadPerformances();
                loadStats();
                alert('Performance deleted successfully!');
            } else {
                const error = await response.json();
                alert(error.detail || 'Failed to delete performance');
            }
        } catch (error) {
            console.error('Error deleting performance:', error);
            alert('Failed to delete performance');
        }
    }

    // Pricing management
    async function loadPerformancesForPricing() {
        try {
            const response = await fetch('/api/performances/');
            if (response.ok) {
                const performances = await response.json();
                const select = document.getElementById('pricingPerformanceSelect');
                select.innerHTML = '<option value="">-- Select Performance --</option>' + 
                    performances.map(p => `<option value="${p.performance_id}">${p.show_title || 'Unknown'} - ${p.performance_date} ${p.start_time}</option>`).join('');
            }
        } catch (error) {
            console.error('Error loading performances:', error);
        }
    }

    async function loadPricingForPerformance() {
        const performanceId = document.getElementById('pricingPerformanceSelect').value;
        const addBtn = document.getElementById('addPricingBtn');
        
        if (!performanceId) {
            document.getElementById('pricingList').innerHTML = '<p class="text-gray-400">Select a performance to manage pricing.</p>';
            addBtn.disabled = true;
            return;
        }
        
        addBtn.disabled = false;
        const token = localStorage.getItem('access_token');
        
        try {
            const response = await fetch(`/api/admin/performances/${performanceId}/pricing`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            if (response.ok) {
                const pricing = await response.json();
                const pricingList = document.getElementById('pricingList');
                
                if (pricing.length === 0) {
                    pricingList.innerHTML = '<p class="text-gray-400">No pricing set for this performance.</p>';
                    return;
                }
                
                pricingList.innerHTML = pricing.map(p => `
                    <div class="bg-[#0a0a0f] rounded-lg p-4 flex justify-between items-center">
                        <div>
                            <h3 class="text-white font-semibold">${p.seat_category}</h3>
                            <p class="text-purple-400 text-lg font-bold mt-1">$${parseFloat(p.price).toFixed(2)}</p>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick='editPricing(${JSON.stringify(p)})' class="px-4 py-2 bg-purple-500 text-white rounded hover:bg-purple-600 transition-colors">
                                Edit
                            </button>
                            <button onclick="deletePricing(${p.pricing_id})" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 transition-colors">
                                Delete
                            </button>
                        </div>
                    </div>
                `).join('');
            }
        } catch (error) {
            console.error('Error loading pricing:', error);
        }
    }

    function openPricingModal() {
        const performanceId = document.getElementById('pricingPerformanceSelect').value;
        if (!performanceId) {
            alert('Please select a performance first');
            return;
        }
        
        document.getElementById('pricingModalTitle').textContent = 'Add Pricing';
        document.getElementById('pricingForm').reset();
        document.getElementById('pricingId').value = '';
        document.getElementById('pricingPerformanceId').value = performanceId;
        document.getElementById('pricingModal').classList.remove('hidden');
        document.getElementById('pricingModal').classList.add('flex');
    }

    function closePricingModal() {
        document.getElementById('pricingModal').classList.add('hidden');
        document.getElementById('pricingModal').classList.remove('flex');
    }

    function editPricing(pricing) {
        document.getElementById('pricingModalTitle').textContent = 'Edit Pricing';
        document.getElementById('pricingId').value = pricing.pricing_id;
        document.getElementById('pricingCategory').value = pricing.seat_category;
        document.getElementById('pricingCategory').disabled = true;
        document.getElementById('pricingPrice').value = pricing.price;
        
        document.getElementById('pricingModal').classList.remove('hidden');
        document.getElementById('pricingModal').classList.add('flex');
    }

    document.getElementById('pricingForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const token = localStorage.getItem('access_token');
        const pricingId = document.getElementById('pricingId').value;
        
        if (pricingId) {
            // Update
            const data = { price: parseFloat(document.getElementById('pricingPrice').value) };
            
            try {
                const response = await fetch(`/api/admin/pricing/${pricingId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    closePricingModal();
                    loadPricingForPerformance();
                    alert('Pricing updated successfully!');
                    document.getElementById('pricingCategory').disabled = false;
                } else {
                    const error = await response.json();
                    alert(error.detail || 'Failed to update pricing');
                }
            } catch (error) {
                console.error('Error updating pricing:', error);
                alert('Failed to update pricing');
            }
        } else {
            // Create
            const data = {
                performance_id: parseInt(document.getElementById('pricingPerformanceId').value),
                seat_category: document.getElementById('pricingCategory').value,
                price: parseFloat(document.getElementById('pricingPrice').value)
            };
            
            try {
                const response = await fetch('/api/admin/pricing', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    closePricingModal();
                    loadPricingForPerformance();
                    alert('Pricing created successfully!');
                } else {
                    const error = await response.json();
                    alert(error.detail || 'Failed to create pricing');
                }
            } catch (error) {
                console.error('Error creating pricing:', error);
                alert('Failed to create pricing');
            }
        }
    });

    async function deletePricing(pricingId) {
        if (!confirm('Are you sure you want to delete this pricing?')) return;
        
        const token = localStorage.getItem('access_token');
        
        try {
            const response = await fetch(`/api/admin/pricing/${pricingId}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            if (response.ok) {
                loadPricingForPerformance();
                alert('Pricing deleted successfully!');
            } else {
                const error = await response.json();
                alert(error.detail || 'Failed to delete pricing');
            }
        } catch (error) {
            console.error('Error deleting pricing:', error);
            alert('Failed to delete pricing');
        }
    }

    // Analytics functions
    async function loadAnalytics() {
        const token = localStorage.getItem('access_token');
        
        try {
            // Load dashboard overview
            const dashResponse = await fetch('/api/analytics/dashboard', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            if (dashResponse.ok) {
                const data = await response.json();
                
                document.getElementById('analyticsOverview').innerHTML = `
                    <div class="bg-[#0a0a0f] rounded-lg p-6">
                        <p class="text-gray-400 text-sm mb-2">Total Revenue</p>
                        <p class="text-3xl font-bold text-green-500">$${data.revenue.total.toFixed(2)}</p>
                        <p class="text-gray-500 text-sm mt-2">All time</p>
                    </div>
                    <div class="bg-[#0a0a0f] rounded-lg p-6">
                        <p class="text-gray-400 text-sm mb-2">Booking Rate</p>
                        <p class="text-3xl font-bold text-blue-500">${data.bookings.confirmation_rate.toFixed(1)}%</p>
                        <p class="text-gray-500 text-sm mt-2">${data.bookings.confirmed}/${data.bookings.total} confirmed</p>
                    </div>
                    <div class="bg-[#0a0a0f] rounded-lg p-6">
                        <p class="text-gray-400 text-sm mb-2">Payment Success</p>
                        <p class="text-3xl font-bold text-purple-500">${data.payments.success_rate}%</p>
                        <p class="text-gray-500 text-sm mt-2">${data.payments.successful}/${data.payments.total_attempts} successful</p>
                    </div>
                `;
            }
            
            // Load popular shows
            const showsResponse = await fetch('/api/analytics/popular-shows?limit=5', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            if (showsResponse.ok) {
                const shows = await showsResponse.json();
                document.getElementById('popularShows').innerHTML = shows.map((show, idx) => `
                    <div class="flex justify-between items-center p-3 bg-[#0a0a0f] rounded">
                        <div class="flex items-center">
                            <span class="text-2xl font-bold text-purple-500 mr-3">${idx + 1}</span>
                            <div>
                                <p class="text-white font-semibold">${show.title}</p>
                                <p class="text-gray-400 text-sm">${show.booking_count} bookings</p>
                            </div>
                        </div>
                        <span class="text-green-500 font-bold">$${show.total_revenue.toFixed(2)}</span>
                    </div>
                `).join('');
            }
            
            // Load payment methods
            const paymentResponse = await fetch('/api/analytics/payment-methods', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            if (paymentResponse.ok) {
                const methods = await paymentResponse.json();
                document.getElementById('paymentMethods').innerHTML = methods.map(method => `
                    <div class="flex justify-between items-center p-3 bg-[#0a0a0f] rounded">
                        <div>
                            <p class="text-white font-semibold">${method.payment_method}</p>
                            <p class="text-gray-400 text-sm">${method.transaction_count} transactions</p>
                        </div>
                        <span class="text-purple-400 font-bold">$${method.total_amount.toFixed(2)}</span>
                    </div>
                `).join('');
            }
            
            // Load genre performance
            const genreResponse = await fetch('/api/analytics/genre-performance', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            if (genreResponse.ok) {
                const genres = await genreResponse.json();
                document.getElementById('genrePerformance').innerHTML = genres.map(genre => `
                    <div class="p-3 bg-[#0a0a0f] rounded">
                        <div class="flex justify-between items-center mb-2">
                            <p class="text-white font-semibold">${genre.genre}</p>
                            <span class="text-green-500 font-bold">$${genre.revenue.toFixed(2)}</span>
                        </div>
                        <div class="flex justify-between text-sm text-gray-400">
                            <span>${genre.show_count} shows</span>
                            <span>${genre.booking_count} bookings</span>
                        </div>
                    </div>
                `).join('');
            }
            
            // Load venue utilization
            const venueResponse = await fetch('/api/analytics/venue-utilization', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            if (venueResponse.ok) {
                const venues = await venueResponse.json();
                document.getElementById('venueUtilization').innerHTML = venues.map(venue => `
                    <div class="p-3 bg-[#0a0a0f] rounded">
                        <div class="flex justify-between items-center mb-2">
                            <p class="text-white font-semibold">${venue.venue_name}</p>
                            <span class="text-purple-400 font-bold">${venue.utilization_rate}%</span>
                        </div>
                        <div class="text-sm text-gray-400">
                            ${venue.seats_sold} seats sold ‚Ä¢ ${venue.performance_count} performances
                        </div>
                    </div>
                `).join('');
            }
            
            // Load revenue by performance
            const revenueResponse = await fetch('/api/analytics/revenue-by-performance', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            if (revenueResponse.ok) {
                const performances = await revenueResponse.json();
                document.getElementById('revenueByPerformance').innerHTML = `
                    <table class="w-full text-left">
                        <thead>
                            <tr class="border-b border-gray-700">
                                <th class="pb-3 text-gray-400 font-semibold">Show</th>
                                <th class="pb-3 text-gray-400 font-semibold">Date</th>
                                <th class="pb-3 text-gray-400 font-semibold">Venue</th>
                                <th class="pb-3 text-gray-400 font-semibold text-right">Bookings</th>
                                <th class="pb-3 text-gray-400 font-semibold text-right">Revenue</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${performances.map(perf => `
                                <tr class="border-b border-gray-800">
                                    <td class="py-3 text-white">${perf.show_title}</td>
                                    <td class="py-3 text-gray-400">${new Date(perf.performance_date).toLocaleDateString()}</td>
                                    <td class="py-3 text-gray-400">${perf.venue_name}</td>
                                    <td class="py-3 text-gray-400 text-right">${perf.booking_count}</td>
                                    <td class="py-3 text-green-500 font-bold text-right">$${perf.revenue.toFixed(2)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            }
            
        } catch (error) {
            console.error('Error loading analytics:', error);
        }
    }

    // =============================================
    // RBAC - USER MANAGEMENT
    // =============================================
    
    let allUsers = [];
    let allRoles = [];
    
    async function loadUsers() {
        const token = localStorage.getItem('access_token');
        const search = document.getElementById('userSearch')?.value || '';
        const status = document.getElementById('userStatusFilter')?.value || '';
        
        try {
            let url = '/api/admin/users?limit=100';
            if (search) url += `&search=${encodeURIComponent(search)}`;
            if (status) url += `&account_status=${status}`;
            
            const response = await fetch(url, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            if (response.ok) {
                const data = await response.json();
                allUsers = data.users;
                renderUsers(allUsers);
            }
        } catch (error) {
            console.error('Error loading users:', error);
        }
    }
    
    function renderUsers(users) {
        const tbody = document.getElementById('usersTableBody');
        if (!tbody) return;
        
        tbody.innerHTML = users.map(user => `
            <tr class="border-b border-gray-800 hover:bg-gray-800/50">
                <td class="py-3 px-2">
                    <div class="flex items-center space-x-3">
                        <div class="w-8 h-8 rounded-full bg-purple-500/20 flex items-center justify-center text-purple-400 text-sm font-bold">
                            ${user.first_name[0]}${user.last_name[0]}
                        </div>
                        <div>
                            <div class="font-medium">${user.first_name} ${user.last_name}</div>
                            ${user.is_admin ? '<span class="text-xs text-purple-400">Admin</span>' : ''}
                        </div>
                    </div>
                </td>
                <td class="py-3 px-2 text-gray-400">${user.email}</td>
                <td class="py-3 px-2">
                    <span class="px-2 py-1 rounded-full text-xs ${
                        user.account_status === 'Active' ? 'bg-green-500/20 text-green-400' :
                        user.account_status === 'Suspended' ? 'bg-yellow-500/20 text-yellow-400' :
                        'bg-red-500/20 text-red-400'
                    }">${user.account_status}</span>
                </td>
                <td class="py-3 px-2 text-gray-400">${user.role_name || '-'}</td>
                <td class="py-3 px-2 text-gray-400">${user.booking_count}</td>
                <td class="py-3 px-2">
                    <button onclick="editUser(${user.user_id})" class="text-purple-400 hover:text-purple-300 mr-2">Edit</button>
                    <button onclick="viewUserDetails(${user.user_id})" class="text-blue-400 hover:text-blue-300">View</button>
                </td>
            </tr>
        `).join('');
    }
    
    function searchUsers() {
        clearTimeout(window.userSearchTimeout);
        window.userSearchTimeout = setTimeout(loadUsers, 300);
    }
    
    function filterUsers() {
        loadUsers();
    }
    
    async function editUser(userId) {
        const token = localStorage.getItem('access_token');
        
        // Load roles first
        await loadRolesForSelect();
        
        const user = allUsers.find(u => u.user_id === userId);
        if (!user) return;
        
        document.getElementById('editUserId').value = userId;
        document.getElementById('editUserName').textContent = `${user.first_name} ${user.last_name}`;
        document.getElementById('editUserEmail').textContent = user.email;
        document.getElementById('editUserStatus').value = user.account_status;
        document.getElementById('editUserRole').value = user.role_id || '';
        document.getElementById('editUserAdmin').checked = user.is_admin;
        
        document.getElementById('userModal').classList.remove('hidden');
        document.getElementById('userModal').classList.add('flex');
    }
    
    async function loadRolesForSelect() {
        const token = localStorage.getItem('access_token');
        try {
            const response = await fetch('/api/admin/roles', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (response.ok) {
                allRoles = await response.json();
                const select = document.getElementById('editUserRole');
                select.innerHTML = '<option value="">No Role</option>' + 
                    allRoles.map(r => `<option value="${r.role_id}">${r.role_name}</option>`).join('');
            }
        } catch (error) {
            console.error('Error loading roles:', error);
        }
    }
    
    function closeUserModal() {
        document.getElementById('userModal').classList.add('hidden');
        document.getElementById('userModal').classList.remove('flex');
    }
    
    document.getElementById('userForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const token = localStorage.getItem('access_token');
        const userId = document.getElementById('editUserId').value;
        
        const data = {
            account_status: document.getElementById('editUserStatus').value,
            is_admin: document.getElementById('editUserAdmin').checked,
            role_id: document.getElementById('editUserRole').value ? parseInt(document.getElementById('editUserRole').value) : null
        };
        
        try {
            const response = await fetch(`/api/admin/users/${userId}`, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });
            
            if (response.ok) {
                alert('User updated successfully');
                closeUserModal();
                loadUsers();
            } else {
                const error = await response.json();
                alert(error.detail || 'Failed to update user');
            }
        } catch (error) {
            console.error('Error updating user:', error);
            alert('Failed to update user');
        }
    });
    
    async function viewUserDetails(userId) {
        const token = localStorage.getItem('access_token');
        try {
            const response = await fetch(`/api/admin/users/${userId}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (response.ok) {
                const user = await response.json();
                alert(`User Details:\n\nName: ${user.first_name} ${user.last_name}\nEmail: ${user.email}\nStatus: ${user.account_status}\nRole: ${user.role_name || 'None'}\nBookings: ${user.booking_count}\nRegistered: ${user.registration_date}`);
            }
        } catch (error) {
            console.error('Error loading user details:', error);
        }
    }

    // =============================================
    // RBAC - BOOKING MANAGEMENT
    // =============================================
    
    let allAdminBookings = [];
    
    async function loadAdminBookings() {
        const token = localStorage.getItem('access_token');
        const search = document.getElementById('bookingSearch')?.value || '';
        const status = document.getElementById('bookingStatusFilter')?.value || '';
        
        try {
            let url = '/api/admin/bookings?limit=100';
            if (search) url += `&search=${encodeURIComponent(search)}`;
            if (status) url += `&booking_status=${status}`;
            
            const response = await fetch(url, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            if (response.ok) {
                const data = await response.json();
                allAdminBookings = data.bookings;
                renderAdminBookings(allAdminBookings);
            }
        } catch (error) {
            console.error('Error loading bookings:', error);
        }
    }
    
    function renderAdminBookings(bookings) {
        const tbody = document.getElementById('bookingsTableBody');
        if (!tbody) return;
        
        tbody.innerHTML = bookings.map(booking => `
            <tr class="border-b border-gray-800 hover:bg-gray-800/50">
                <td class="py-3 px-2 font-mono text-purple-400">${booking.booking_reference}</td>
                <td class="py-3 px-2">
                    <div>${booking.user_name}</div>
                    <div class="text-sm text-gray-500">${booking.user_email}</div>
                </td>
                <td class="py-3 px-2 text-gray-400">${booking.show_title}</td>
                <td class="py-3 px-2 text-gray-400">${new Date(booking.performance_date).toLocaleDateString()}</td>
                <td class="py-3 px-2 text-gray-400">${booking.seat_count}</td>
                <td class="py-3 px-2 text-green-400">$${booking.total_amount.toFixed(2)}</td>
                <td class="py-3 px-2">
                    <span class="px-2 py-1 rounded-full text-xs ${
                        booking.booking_status === 'Confirmed' ? 'bg-green-500/20 text-green-400' :
                        booking.booking_status === 'Pending' ? 'bg-yellow-500/20 text-yellow-400' :
                        booking.booking_status === 'Refunded' ? 'bg-blue-500/20 text-blue-400' :
                        'bg-red-500/20 text-red-400'
                    }">${booking.booking_status}</span>
                </td>
                <td class="py-3 px-2">
                    ${booking.booking_status === 'Confirmed' ? `
                        <button onclick="openRefundModalAdmin(${booking.booking_id}, '${booking.booking_reference}', ${booking.total_amount})" 
                                class="text-blue-400 hover:text-blue-300 mr-2">Refund</button>
                    ` : ''}
                    ${booking.booking_status !== 'Cancelled' && booking.booking_status !== 'Refunded' ? `
                        <button onclick="cancelBookingAdmin(${booking.booking_id})" 
                                class="text-red-400 hover:text-red-300">Cancel</button>
                    ` : ''}
                </td>
            </tr>
        `).join('');
    }
    
    function searchBookings() {
        clearTimeout(window.bookingSearchTimeout);
        window.bookingSearchTimeout = setTimeout(loadAdminBookings, 300);
    }
    
    function filterBookingsAdmin() {
        loadAdminBookings();
    }
    
    async function cancelBookingAdmin(bookingId) {
        const reason = prompt('Enter reason for cancellation:');
        if (!reason) return;
        
        const token = localStorage.getItem('access_token');
        
        try {
            const response = await fetch(`/api/admin/bookings/${bookingId}/cancel`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ reason })
            });
            
            if (response.ok) {
                alert('Booking cancelled successfully');
                loadAdminBookings();
            } else {
                const error = await response.json();
                alert(error.detail || 'Failed to cancel booking');
            }
        } catch (error) {
            console.error('Error cancelling booking:', error);
        }
    }
    
    function openRefundModalAdmin(bookingId, reference, amount) {
        document.getElementById('refundBookingId').value = bookingId;
        document.getElementById('refundBookingRef').textContent = reference;
        document.getElementById('refundOriginalAmount').textContent = `$${amount.toFixed(2)}`;
        document.getElementById('refundAmount').value = '';
        document.getElementById('refundReason').value = '';
        
        document.getElementById('refundModal').classList.remove('hidden');
        document.getElementById('refundModal').classList.add('flex');
    }
    
    function closeRefundModal() {
        document.getElementById('refundModal').classList.add('hidden');
        document.getElementById('refundModal').classList.remove('flex');
    }
    
    document.getElementById('refundForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const token = localStorage.getItem('access_token');
        const bookingId = document.getElementById('refundBookingId').value;
        const amount = document.getElementById('refundAmount').value;
        const reason = document.getElementById('refundReason').value;
        
        try {
            const response = await fetch(`/api/admin/bookings/${bookingId}/refund`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    reason,
                    refund_amount: amount ? parseFloat(amount) : null
                })
            });
            
            if (response.ok) {
                const result = await response.json();
                alert(`Refund issued: $${result.refund_amount.toFixed(2)}`);
                closeRefundModal();
                loadAdminBookings();
            } else {
                const error = await response.json();
                alert(error.detail || 'Failed to issue refund');
            }
        } catch (error) {
            console.error('Error issuing refund:', error);
        }
    });

    // =============================================
    // RBAC - ROLE MANAGEMENT
    // =============================================
    
    async function loadRoles() {
        const token = localStorage.getItem('access_token');
        
        try {
            const response = await fetch('/api/admin/roles', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            if (response.ok) {
                const roles = await response.json();
                renderRoles(roles);
            }
        } catch (error) {
            console.error('Error loading roles:', error);
        }
    }
    
    function renderRoles(roles) {
        const container = document.getElementById('rolesList');
        if (!container) return;
        
        if (roles.length === 0) {
            container.innerHTML = '<p class="text-gray-400 col-span-3">No roles defined yet. Create one to get started.</p>';
            return;
        }
        
        container.innerHTML = roles.map(role => `
            <div class="bg-[#0a0a0f] rounded-lg p-4 border border-gray-800">
                <div class="flex justify-between items-start mb-3">
                    <div>
                        <h4 class="text-lg font-semibold text-white">${role.role_name}</h4>
                        <p class="text-sm text-gray-500">${role.description || 'No description'}</p>
                    </div>
                    <span class="text-xs text-gray-500">${role.user_count} users</span>
                </div>
                <div class="flex flex-wrap gap-1 mb-3">
                    ${role.can_manage_shows ? '<span class="px-2 py-0.5 bg-purple-500/20 text-purple-400 rounded text-xs">Shows</span>' : ''}
                    ${role.can_manage_venues ? '<span class="px-2 py-0.5 bg-purple-500/20 text-purple-400 rounded text-xs">Venues</span>' : ''}
                    ${role.can_manage_performances ? '<span class="px-2 py-0.5 bg-purple-500/20 text-purple-400 rounded text-xs">Performances</span>' : ''}
                    ${role.can_manage_bookings ? '<span class="px-2 py-0.5 bg-blue-500/20 text-blue-400 rounded text-xs">Bookings</span>' : ''}
                    ${role.can_view_analytics ? '<span class="px-2 py-0.5 bg-green-500/20 text-green-400 rounded text-xs">Analytics</span>' : ''}
                    ${role.can_manage_users ? '<span class="px-2 py-0.5 bg-yellow-500/20 text-yellow-400 rounded text-xs">Users</span>' : ''}
                    ${role.can_manage_pricing ? '<span class="px-2 py-0.5 bg-pink-500/20 text-pink-400 rounded text-xs">Pricing</span>' : ''}
                    ${role.can_issue_refunds ? '<span class="px-2 py-0.5 bg-red-500/20 text-red-400 rounded text-xs">Refunds</span>' : ''}
                </div>
                <div class="flex space-x-2">
                    <button onclick="editRole(${role.role_id})" class="text-sm text-purple-400 hover:text-purple-300">Edit</button>
                    ${role.user_count === 0 ? `<button onclick="deleteRole(${role.role_id})" class="text-sm text-red-400 hover:text-red-300">Delete</button>` : ''}
                </div>
            </div>
        `).join('');
    }
    
    function openRoleModal(roleId = null) {
        document.getElementById('roleModalTitle').textContent = roleId ? 'Edit Role' : 'Add Role';
        document.getElementById('roleId').value = roleId || '';
        
        if (!roleId) {
            document.getElementById('roleName').value = '';
            document.getElementById('roleDescription').value = '';
            document.getElementById('permManageShows').checked = false;
            document.getElementById('permManageVenues').checked = false;
            document.getElementById('permManagePerformances').checked = false;
            document.getElementById('permManageBookings').checked = false;
            document.getElementById('permViewAnalytics').checked = false;
            document.getElementById('permManageUsers').checked = false;
            document.getElementById('permManagePricing').checked = false;
            document.getElementById('permIssueRefunds').checked = false;
        }
        
        document.getElementById('roleModal').classList.remove('hidden');
        document.getElementById('roleModal').classList.add('flex');
    }
    
    async function editRole(roleId) {
        const token = localStorage.getItem('access_token');
        
        try {
            const response = await fetch('/api/admin/roles', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            if (response.ok) {
                const roles = await response.json();
                const role = roles.find(r => r.role_id === roleId);
                
                if (role) {
                    document.getElementById('roleId').value = role.role_id;
                    document.getElementById('roleName').value = role.role_name;
                    document.getElementById('roleDescription').value = role.description || '';
                    document.getElementById('permManageShows').checked = role.can_manage_shows;
                    document.getElementById('permManageVenues').checked = role.can_manage_venues;
                    document.getElementById('permManagePerformances').checked = role.can_manage_performances;
                    document.getElementById('permManageBookings').checked = role.can_manage_bookings;
                    document.getElementById('permViewAnalytics').checked = role.can_view_analytics;
                    document.getElementById('permManageUsers').checked = role.can_manage_users;
                    document.getElementById('permManagePricing').checked = role.can_manage_pricing;
                    document.getElementById('permIssueRefunds').checked = role.can_issue_refunds;
                    
                    openRoleModal(roleId);
                }
            }
        } catch (error) {
            console.error('Error loading role:', error);
        }
    }
    
    function closeRoleModal() {
        document.getElementById('roleModal').classList.add('hidden');
        document.getElementById('roleModal').classList.remove('flex');
    }
    
    document.getElementById('roleForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const token = localStorage.getItem('access_token');
        const roleId = document.getElementById('roleId').value;
        
        const data = {
            role_name: document.getElementById('roleName').value,
            description: document.getElementById('roleDescription').value,
            can_manage_shows: document.getElementById('permManageShows').checked,
            can_manage_venues: document.getElementById('permManageVenues').checked,
            can_manage_performances: document.getElementById('permManagePerformances').checked,
            can_manage_bookings: document.getElementById('permManageBookings').checked,
            can_view_analytics: document.getElementById('permViewAnalytics').checked,
            can_manage_users: document.getElementById('permManageUsers').checked,
            can_manage_pricing: document.getElementById('permManagePricing').checked,
            can_issue_refunds: document.getElementById('permIssueRefunds').checked
        };
        
        try {
            const url = roleId ? `/api/admin/roles/${roleId}` : '/api/admin/roles';
            const method = roleId ? 'PUT' : 'POST';
            
            const response = await fetch(url, {
                method,
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });
            
            if (response.ok) {
                alert(roleId ? 'Role updated successfully' : 'Role created successfully');
                closeRoleModal();
                loadRoles();
            } else {
                const error = await response.json();
                alert(error.detail || 'Failed to save role');
            }
        } catch (error) {
            console.error('Error saving role:', error);
        }
    });
    
    async function deleteRole(roleId) {
        if (!confirm('Are you sure you want to delete this role?')) return;
        
        const token = localStorage.getItem('access_token');
        
        try {
            const response = await fetch(`/api/admin/roles/${roleId}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            if (response.ok) {
                alert('Role deleted successfully');
                loadRoles();
            } else {
                const error = await response.json();
                alert(error.detail || 'Failed to delete role');
            }
        } catch (error) {
            console.error('Error deleting role:', error);
        }
    }

    // =============================================
    // AUDIT LOGS
    // =============================================
    
    async function loadAuditLogs() {
        const token = localStorage.getItem('access_token');
        const action = document.getElementById('auditActionFilter')?.value || '';
        const entityType = document.getElementById('auditEntityFilter')?.value || '';
        
        try {
            // Load filter options
            loadAuditFilterOptions();
            
            let url = '/api/admin/audit-logs?limit=100';
            if (action) url += `&action=${action}`;
            if (entityType) url += `&entity_type=${entityType}`;
            
            const response = await fetch(url, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            if (response.ok) {
                const data = await response.json();
                renderAuditLogs(data.logs);
            }
        } catch (error) {
            console.error('Error loading audit logs:', error);
        }
    }
    
    async function loadAuditFilterOptions() {
        const token = localStorage.getItem('access_token');
        
        try {
            const [actionsRes, typesRes] = await Promise.all([
                fetch('/api/admin/audit-logs/actions', { headers: { 'Authorization': `Bearer ${token}` } }),
                fetch('/api/admin/audit-logs/entity-types', { headers: { 'Authorization': `Bearer ${token}` } })
            ]);
            
            if (actionsRes.ok) {
                const actions = await actionsRes.json();
                const select = document.getElementById('auditActionFilter');
                if (select && select.options.length <= 1) {
                    actions.forEach(a => {
                        const opt = document.createElement('option');
                        opt.value = a;
                        opt.textContent = a.replace(/_/g, ' ');
                        select.appendChild(opt);
                    });
                }
            }
            
            if (typesRes.ok) {
                const types = await typesRes.json();
                const select = document.getElementById('auditEntityFilter');
                if (select && select.options.length <= 1) {
                    types.forEach(t => {
                        const opt = document.createElement('option');
                        opt.value = t;
                        opt.textContent = t;
                        select.appendChild(opt);
                    });
                }
            }
        } catch (error) {
            console.error('Error loading filter options:', error);
        }
    }
    
    function renderAuditLogs(logs) {
        const tbody = document.getElementById('auditLogsTableBody');
        if (!tbody) return;
        
        if (logs.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="py-4 text-center text-gray-500">No audit logs found</td></tr>';
            return;
        }
        
        tbody.innerHTML = logs.map(log => `
            <tr class="border-b border-gray-800 hover:bg-gray-800/50">
                <td class="py-3 px-2 text-gray-400 text-sm">${new Date(log.timestamp).toLocaleString()}</td>
                <td class="py-3 px-2">
                    <div class="text-white">${log.user_name}</div>
                    <div class="text-xs text-gray-500">${log.user_email}</div>
                </td>
                <td class="py-3 px-2">
                    <span class="px-2 py-1 rounded text-xs ${
                        log.action.includes('CREATE') ? 'bg-green-500/20 text-green-400' :
                        log.action.includes('UPDATE') ? 'bg-blue-500/20 text-blue-400' :
                        log.action.includes('DELETE') || log.action.includes('CANCEL') ? 'bg-red-500/20 text-red-400' :
                        'bg-gray-500/20 text-gray-400'
                    }">${log.action.replace(/_/g, ' ')}</span>
                </td>
                <td class="py-3 px-2 text-gray-400">${log.entity_type} ${log.entity_id ? '#' + log.entity_id : ''}</td>
                <td class="py-3 px-2">
                    <button onclick="showAuditDetails(${JSON.stringify(log).replace(/"/g, '&quot;')})" 
                            class="text-purple-400 hover:text-purple-300 text-sm">View Details</button>
                </td>
            </tr>
        `).join('');
    }
    
    function filterAuditLogs() {
        loadAuditLogs();
    }
    
    function showAuditDetails(log) {
        let details = `Action: ${log.action}\nEntity: ${log.entity_type} #${log.entity_id || 'N/A'}\nUser: ${log.user_name}\nTime: ${new Date(log.timestamp).toLocaleString()}\nIP: ${log.ip_address || 'N/A'}`;
        
        if (log.old_values) {
            details += `\n\nOld Values:\n${JSON.stringify(log.old_values, null, 2)}`;
        }
        if (log.new_values) {
            details += `\n\nNew Values:\n${JSON.stringify(log.new_values, null, 2)}`;
        }
        
        alert(details);
    }

    // CSS for active tab
    const style = document.createElement('style');
    style.textContent = `
        .tab-btn.active {
            background: linear-gradient(to right, rgb(168, 85, 247), rgb(236, 72, 153));
            color: white;
        }
    `;
    document.head.appendChild(style);

    // Initialize
    if (checkAdminAccess()) {
        loadStats();
        loadShows();
    }
</script>
{% endblock %}
