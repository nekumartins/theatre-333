{% extends "base.html" %}

{% block title %}Admin Panel - Theatre Booking System{% endblock %}

{% block content %}
<div class="min-h-screen bg-[#0a0a0f] py-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Header -->
        <div class="mb-8">
            <h1 class="text-4xl font-bold bg-gradient-to-r from-purple-500 to-pink-500 bg-clip-text text-transparent">
                Admin Panel
            </h1>
            <p class="mt-2 text-gray-400">Manage shows, venues, and performances</p>
        </div>

        <!-- Stats Cards -->
        <div id="statsSection" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- Stats will be loaded here -->
        </div>

        <!-- Tab Navigation -->
        <div class="bg-[#12121a] rounded-lg p-1 mb-6 inline-flex space-x-1">
            <button onclick="switchTab('shows')" id="showsTab" class="tab-btn active px-6 py-3 rounded-md transition-all">
                Shows
            </button>
            <button onclick="switchTab('venues')" id="venuesTab" class="tab-btn px-6 py-3 rounded-md transition-all">
                Venues
            </button>
            <button onclick="switchTab('performances')" id="performancesTab" class="tab-btn px-6 py-3 rounded-md transition-all">
                Performances
            </button>
        </div>

        <!-- Shows Management -->
        <div id="showsSection" class="tab-content">
            <div class="bg-[#12121a] rounded-lg p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-semibold text-white">Manage Shows</h2>
                    <button onclick="openShowModal()" class="px-4 py-2 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-lg hover:opacity-90 transition-opacity">
                        + Add Show
                    </button>
                </div>
                <div id="showsList" class="space-y-4">
                    <!-- Shows will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Venues Management -->
        <div id="venuesSection" class="tab-content hidden">
            <div class="bg-[#12121a] rounded-lg p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-semibold text-white">Manage Venues</h2>
                    <button onclick="openVenueModal()" class="px-4 py-2 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-lg hover:opacity-90 transition-opacity">
                        + Add Venue
                    </button>
                </div>
                <div id="venuesList" class="space-y-4">
                    <!-- Venues will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Performances Management -->
        <div id="performancesSection" class="tab-content hidden">
            <div class="bg-[#12121a] rounded-lg p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-semibold text-white">Manage Performances</h2>
                    <button onclick="openPerformanceModal()" class="px-4 py-2 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-lg hover:opacity-90 transition-opacity">
                        + Add Performance
                    </button>
                </div>
                <div id="performancesList" class="space-y-4">
                    <!-- Performances will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Show Modal -->
<div id="showModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-[#12121a] rounded-lg p-8 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
        <h3 id="showModalTitle" class="text-2xl font-bold text-white mb-6">Add Show</h3>
        <form id="showForm" class="space-y-4">
            <input type="hidden" id="showId">
            <div class="grid grid-cols-2 gap-4">
                <div class="col-span-2">
                    <label class="block text-gray-300 mb-2">Title *</label>
                    <input type="text" id="showTitle" required class="w-full px-4 py-2 bg-[#0a0a0f] border border-gray-700 rounded-lg text-white focus:border-purple-500 focus:outline-none">
                </div>
                <div class="col-span-2">
                    <label class="block text-gray-300 mb-2">Description</label>
                    <textarea id="showDescription" rows="3" class="w-full px-4 py-2 bg-[#0a0a0f] border border-gray-700 rounded-lg text-white focus:border-purple-500 focus:outline-none"></textarea>
                </div>
                <div>
                    <label class="block text-gray-300 mb-2">Genre *</label>
                    <select id="showGenre" required class="w-full px-4 py-2 bg-[#0a0a0f] border border-gray-700 rounded-lg text-white focus:border-purple-500 focus:outline-none">
                        <!-- Will be populated dynamically -->
                    </select>
                </div>
                <div>
                    <label class="block text-gray-300 mb-2">Duration (minutes) *</label>
                    <input type="number" id="showDuration" required class="w-full px-4 py-2 bg-[#0a0a0f] border border-gray-700 rounded-lg text-white focus:border-purple-500 focus:outline-none">
                </div>
                <div>
                    <label class="block text-gray-300 mb-2">Language</label>
                    <input type="text" id="showLanguage" class="w-full px-4 py-2 bg-[#0a0a0f] border border-gray-700 rounded-lg text-white focus:border-purple-500 focus:outline-none">
                </div>
                <div>
                    <label class="block text-gray-300 mb-2">Age Rating</label>
                    <input type="text" id="showAgeRating" class="w-full px-4 py-2 bg-[#0a0a0f] border border-gray-700 rounded-lg text-white focus:border-purple-500 focus:outline-none">
                </div>
                <div>
                    <label class="block text-gray-300 mb-2">Producer</label>
                    <input type="text" id="showProducer" class="w-full px-4 py-2 bg-[#0a0a0f] border border-gray-700 rounded-lg text-white focus:border-purple-500 focus:outline-none">
                </div>
                <div>
                    <label class="block text-gray-300 mb-2">Director</label>
                    <input type="text" id="showDirector" class="w-full px-4 py-2 bg-[#0a0a0f] border border-gray-700 rounded-lg text-white focus:border-purple-500 focus:outline-none">
                </div>
                <div class="col-span-2">
                    <label class="block text-gray-300 mb-2">Poster URL</label>
                    <input type="url" id="showPosterUrl" class="w-full px-4 py-2 bg-[#0a0a0f] border border-gray-700 rounded-lg text-white focus:border-purple-500 focus:outline-none">
                </div>
                <div>
                    <label class="block text-gray-300 mb-2">Status</label>
                    <select id="showStatus" class="w-full px-4 py-2 bg-[#0a0a0f] border border-gray-700 rounded-lg text-white focus:border-purple-500 focus:outline-none">
                        <option value="Active">Active</option>
                        <option value="Inactive">Inactive</option>
                    </select>
                </div>
            </div>
            <div class="flex justify-end space-x-4 mt-6">
                <button type="button" onclick="closeShowModal()" class="px-6 py-2 bg-gray-700 text-white rounded-lg hover:bg-gray-600 transition-colors">
                    Cancel
                </button>
                <button type="submit" class="px-6 py-2 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-lg hover:opacity-90 transition-opacity">
                    Save
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Venue Modal -->
<div id="venueModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-[#12121a] rounded-lg p-8 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
        <h3 id="venueModalTitle" class="text-2xl font-bold text-white mb-6">Add Venue</h3>
        <form id="venueForm" class="space-y-4">
            <input type="hidden" id="venueId">
            <div class="grid grid-cols-2 gap-4">
                <div class="col-span-2">
                    <label class="block text-gray-300 mb-2">Venue Name *</label>
                    <input type="text" id="venueName" required class="w-full px-4 py-2 bg-[#0a0a0f] border border-gray-700 rounded-lg text-white focus:border-purple-500 focus:outline-none">
                </div>
                <div class="col-span-2">
                    <label class="block text-gray-300 mb-2">Address Line 1 *</label>
                    <input type="text" id="venueAddress1" required class="w-full px-4 py-2 bg-[#0a0a0f] border border-gray-700 rounded-lg text-white focus:border-purple-500 focus:outline-none">
                </div>
                <div class="col-span-2">
                    <label class="block text-gray-300 mb-2">Address Line 2</label>
                    <input type="text" id="venueAddress2" class="w-full px-4 py-2 bg-[#0a0a0f] border border-gray-700 rounded-lg text-white focus:border-purple-500 focus:outline-none">
                </div>
                <div>
                    <label class="block text-gray-300 mb-2">City *</label>
                    <input type="text" id="venueCity" required class="w-full px-4 py-2 bg-[#0a0a0f] border border-gray-700 rounded-lg text-white focus:border-purple-500 focus:outline-none">
                </div>
                <div>
                    <label class="block text-gray-300 mb-2">Postal Code</label>
                    <input type="text" id="venuePostalCode" class="w-full px-4 py-2 bg-[#0a0a0f] border border-gray-700 rounded-lg text-white focus:border-purple-500 focus:outline-none">
                </div>
                <div>
                    <label class="block text-gray-300 mb-2">Country *</label>
                    <input type="text" id="venueCountry" required class="w-full px-4 py-2 bg-[#0a0a0f] border border-gray-700 rounded-lg text-white focus:border-purple-500 focus:outline-none">
                </div>
                <div>
                    <label class="block text-gray-300 mb-2">Total Capacity *</label>
                    <input type="number" id="venueTotalCapacity" required class="w-full px-4 py-2 bg-[#0a0a0f] border border-gray-700 rounded-lg text-white focus:border-purple-500 focus:outline-none">
                </div>
                <div class="col-span-2">
                    <label class="block text-gray-300 mb-2">Phone</label>
                    <input type="tel" id="venuePhone" class="w-full px-4 py-2 bg-[#0a0a0f] border border-gray-700 rounded-lg text-white focus:border-purple-500 focus:outline-none">
                </div>
                <div class="col-span-2">
                    <label class="block text-gray-300 mb-2">Facilities (comma-separated)</label>
                    <textarea id="venueFacilities" rows="2" placeholder="e.g., Parking, Wheelchair Access, Cafe, Gift Shop" class="w-full px-4 py-2 bg-[#0a0a0f] border border-gray-700 rounded-lg text-white focus:border-purple-500 focus:outline-none"></textarea>
                </div>
            </div>
            <div class="flex justify-end space-x-4 mt-6">
                <button type="button" onclick="closeVenueModal()" class="px-6 py-2 bg-gray-700 text-white rounded-lg hover:bg-gray-600 transition-colors">
                    Cancel
                </button>
                <button type="submit" class="px-6 py-2 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-lg hover:opacity-90 transition-opacity">
                    Save
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Performance Modal -->
<div id="performanceModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-[#12121a] rounded-lg p-8 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
        <h3 id="performanceModalTitle" class="text-2xl font-bold text-white mb-6">Add Performance</h3>
        <form id="performanceForm" class="space-y-4">
            <input type="hidden" id="performanceId">
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-gray-300 mb-2">Show *</label>
                    <select id="performanceShow" required class="w-full px-4 py-2 bg-[#0a0a0f] border border-gray-700 rounded-lg text-white focus:border-purple-500 focus:outline-none">
                        <!-- Will be populated dynamically -->
                    </select>
                </div>
                <div>
                    <label class="block text-gray-300 mb-2">Venue *</label>
                    <select id="performanceVenue" required class="w-full px-4 py-2 bg-[#0a0a0f] border border-gray-700 rounded-lg text-white focus:border-purple-500 focus:outline-none">
                        <!-- Will be populated dynamically -->
                    </select>
                </div>
                <div>
                    <label class="block text-gray-300 mb-2">Date *</label>
                    <input type="date" id="performanceDate" required class="w-full px-4 py-2 bg-[#0a0a0f] border border-gray-700 rounded-lg text-white focus:border-purple-500 focus:outline-none">
                </div>
                <div>
                    <label class="block text-gray-300 mb-2">Start Time *</label>
                    <input type="time" id="performanceStartTime" required class="w-full px-4 py-2 bg-[#0a0a0f] border border-gray-700 rounded-lg text-white focus:border-purple-500 focus:outline-none">
                </div>
                <div>
                    <label class="block text-gray-300 mb-2">End Time</label>
                    <input type="time" id="performanceEndTime" class="w-full px-4 py-2 bg-[#0a0a0f] border border-gray-700 rounded-lg text-white focus:border-purple-500 focus:outline-none">
                </div>
                <div>
                    <label class="block text-gray-300 mb-2">Total Seats *</label>
                    <input type="number" id="performanceTotalSeats" required class="w-full px-4 py-2 bg-[#0a0a0f] border border-gray-700 rounded-lg text-white focus:border-purple-500 focus:outline-none">
                </div>
                <div>
                    <label class="block text-gray-300 mb-2">Available Seats *</label>
                    <input type="number" id="performanceAvailableSeats" required class="w-full px-4 py-2 bg-[#0a0a0f] border border-gray-700 rounded-lg text-white focus:border-purple-500 focus:outline-none">
                </div>
                <div>
                    <label class="block text-gray-300 mb-2">Status</label>
                    <select id="performanceStatus" class="w-full px-4 py-2 bg-[#0a0a0f] border border-gray-700 rounded-lg text-white focus:border-purple-500 focus:outline-none">
                        <option value="Scheduled">Scheduled</option>
                        <option value="Cancelled">Cancelled</option>
                        <option value="Completed">Completed</option>
                    </select>
                </div>
                <div class="col-span-2">
                    <label class="block text-gray-300 mb-2">Special Notes</label>
                    <textarea id="performanceNotes" rows="2" class="w-full px-4 py-2 bg-[#0a0a0f] border border-gray-700 rounded-lg text-white focus:border-purple-500 focus:outline-none"></textarea>
                </div>
            </div>
            <div class="flex justify-end space-x-4 mt-6">
                <button type="button" onclick="closePerformanceModal()" class="px-6 py-2 bg-gray-700 text-white rounded-lg hover:bg-gray-600 transition-colors">
                    Cancel
                </button>
                <button type="submit" class="px-6 py-2 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-lg hover:opacity-90 transition-opacity">
                    Save
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    // Check admin access
    function checkAdminAccess() {
        const token = localStorage.getItem('token');
        const isAdmin = localStorage.getItem('is_admin') === 'true';
        
        if (!token || !isTokenValid(token)) {
            window.location.href = '/login';
            return false;
        }
        
        if (!isAdmin) {
            alert('Access denied. Admin privileges required.');
            window.location.href = '/';
            return false;
        }
        
        return true;
    }

    function isTokenValid(token) {
        try {
            const payload = JSON.parse(atob(token.split('.')[1]));
            return payload.exp * 1000 > Date.now();
        } catch {
            return false;
        }
    }

    // Tab switching
    function switchTab(tab) {
        // Hide all tab contents
        document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        
        // Show selected tab
        document.getElementById(`${tab}Section`).classList.remove('hidden');
        document.getElementById(`${tab}Tab`).classList.add('active');
        
        // Load data for the tab
        if (tab === 'shows') loadShows();
        else if (tab === 'venues') loadVenues();
        else if (tab === 'performances') loadPerformances();
    }

    // Load stats
    async function loadStats() {
        const token = localStorage.getItem('token');
        
        try {
            const response = await fetch('/api/admin/stats', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            if (response.ok) {
                const stats = await response.json();
                document.getElementById('statsSection').innerHTML = `
                    <div class="bg-[#12121a] rounded-lg p-6">
                        <div class="text-gray-400 text-sm mb-2">Total Shows</div>
                        <div class="text-3xl font-bold text-white">${stats.shows.total}</div>
                        <div class="text-green-500 text-sm mt-1">${stats.shows.active} active</div>
                    </div>
                    <div class="bg-[#12121a] rounded-lg p-6">
                        <div class="text-gray-400 text-sm mb-2">Total Venues</div>
                        <div class="text-3xl font-bold text-white">${stats.venues.total}</div>
                    </div>
                    <div class="bg-[#12121a] rounded-lg p-6">
                        <div class="text-gray-400 text-sm mb-2">Performances</div>
                        <div class="text-3xl font-bold text-white">${stats.performances.total}</div>
                        <div class="text-purple-500 text-sm mt-1">${stats.performances.upcoming} upcoming</div>
                    </div>
                    <div class="bg-[#12121a] rounded-lg p-6">
                        <div class="text-gray-400 text-sm mb-2">Total Bookings</div>
                        <div class="text-3xl font-bold text-white">${stats.bookings.total}</div>
                        <div class="text-green-500 text-sm mt-1">${stats.bookings.confirmed} confirmed</div>
                    </div>
                `;
            }
        } catch (error) {
            console.error('Error loading stats:', error);
        }
    }

    // Load shows
    async function loadShows() {
        try {
            const response = await fetch('/api/shows/?status=All');
            if (response.ok) {
                const shows = await response.json();
                const showsList = document.getElementById('showsList');
                
                if (shows.length === 0) {
                    showsList.innerHTML = '<p class="text-gray-400">No shows found.</p>';
                    return;
                }
                
                showsList.innerHTML = shows.map(show => `
                    <div class="bg-[#0a0a0f] rounded-lg p-4 flex justify-between items-center">
                        <div>
                            <h3 class="text-white font-semibold text-lg">${show.title}</h3>
                            <p class="text-gray-400 text-sm mt-1">${show.genre_name || 'N/A'} â€¢ ${show.duration_minutes} min</p>
                            <div class="mt-2">
                                <span class="px-2 py-1 text-xs rounded ${show.show_status === 'Active' ? 'bg-green-500/20 text-green-500' : 'bg-gray-500/20 text-gray-500'}">
                                    ${show.show_status}
                                </span>
                            </div>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick='editShow(${JSON.stringify(show)})' class="px-4 py-2 bg-purple-500 text-white rounded hover:bg-purple-600 transition-colors">
                                Edit
                            </button>
                            <button onclick="deleteShow(${show.show_id})" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 transition-colors">
                                Delete
                            </button>
                        </div>
                    </div>
                `).join('');
            }
        } catch (error) {
            console.error('Error loading shows:', error);
        }
    }

    // Load venues
    async function loadVenues() {
        try {
            const response = await fetch('/api/shows/venues/');
            if (response.ok) {
                const venues = await response.json();
                const venuesList = document.getElementById('venuesList');
                
                if (venues.length === 0) {
                    venuesList.innerHTML = '<p class="text-gray-400">No venues found.</p>';
                    return;
                }
                
                venuesList.innerHTML = venues.map(venue => `
                    <div class="bg-[#0a0a0f] rounded-lg p-4 flex justify-between items-center">
                        <div>
                            <h3 class="text-white font-semibold text-lg">${venue.venue_name}</h3>
                            <p class="text-gray-400 text-sm mt-1">${venue.city}, ${venue.country}</p>
                            <p class="text-gray-500 text-sm mt-1">Capacity: ${venue.total_capacity}</p>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick='editVenue(${JSON.stringify(venue)})' class="px-4 py-2 bg-purple-500 text-white rounded hover:bg-purple-600 transition-colors">
                                Edit
                            </button>
                            <button onclick="deleteVenue(${venue.venue_id})" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 transition-colors">
                                Delete
                            </button>
                        </div>
                    </div>
                `).join('');
            }
        } catch (error) {
            console.error('Error loading venues:', error);
        }
    }

    // Load performances
    async function loadPerformances() {
        try {
            const response = await fetch('/api/performances/');
            if (response.ok) {
                const performances = await response.json();
                const performancesList = document.getElementById('performancesList');
                
                if (performances.length === 0) {
                    performancesList.innerHTML = '<p class="text-gray-400">No performances found.</p>';
                    return;
                }
                
                performancesList.innerHTML = performances.map(perf => `
                    <div class="bg-[#0a0a0f] rounded-lg p-4 flex justify-between items-center">
                        <div>
                            <h3 class="text-white font-semibold text-lg">${perf.show_title || 'Unknown Show'}</h3>
                            <p class="text-gray-400 text-sm mt-1">${perf.venue_name || 'Unknown Venue'}</p>
                            <p class="text-gray-500 text-sm mt-1">${perf.performance_date} at ${perf.start_time}</p>
                            <div class="mt-2">
                                <span class="px-2 py-1 text-xs rounded ${perf.performance_status === 'Scheduled' ? 'bg-blue-500/20 text-blue-500' : 'bg-gray-500/20 text-gray-500'}">
                                    ${perf.performance_status}
                                </span>
                            </div>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick='editPerformance(${JSON.stringify(perf)})' class="px-4 py-2 bg-purple-500 text-white rounded hover:bg-purple-600 transition-colors">
                                Edit
                            </button>
                            <button onclick="deletePerformance(${perf.performance_id})" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 transition-colors">
                                Delete
                            </button>
                        </div>
                    </div>
                `).join('');
            }
        } catch (error) {
            console.error('Error loading performances:', error);
        }
    }

    // Show modals
    function openShowModal() {
        document.getElementById('showModalTitle').textContent = 'Add Show';
        document.getElementById('showForm').reset();
        document.getElementById('showId').value = '';
        loadGenres();
        document.getElementById('showModal').classList.remove('hidden');
        document.getElementById('showModal').classList.add('flex');
    }

    function closeShowModal() {
        document.getElementById('showModal').classList.add('hidden');
        document.getElementById('showModal').classList.remove('flex');
    }

    function editShow(show) {
        document.getElementById('showModalTitle').textContent = 'Edit Show';
        document.getElementById('showId').value = show.show_id;
        document.getElementById('showTitle').value = show.title;
        document.getElementById('showDescription').value = show.description || '';
        document.getElementById('showDuration').value = show.duration_minutes;
        document.getElementById('showLanguage').value = show.language || '';
        document.getElementById('showAgeRating').value = show.age_rating || '';
        document.getElementById('showProducer').value = show.producer || '';
        document.getElementById('showDirector').value = show.director || '';
        document.getElementById('showPosterUrl').value = show.poster_url || '';
        document.getElementById('showStatus').value = show.show_status;
        
        loadGenres().then(() => {
            document.getElementById('showGenre').value = show.genre_id;
        });
        
        document.getElementById('showModal').classList.remove('hidden');
        document.getElementById('showModal').classList.add('flex');
    }

    async function loadGenres() {
        try {
            const response = await fetch('/api/shows/genres/');
            if (response.ok) {
                const genres = await response.json();
                const select = document.getElementById('showGenre');
                select.innerHTML = genres.map(g => `<option value="${g.genre_id}">${g.genre_name}</option>`).join('');
            }
        } catch (error) {
            console.error('Error loading genres:', error);
        }
    }

    // Venue modals
    function openVenueModal() {
        document.getElementById('venueModalTitle').textContent = 'Add Venue';
        document.getElementById('venueForm').reset();
        document.getElementById('venueId').value = '';
        document.getElementById('venueModal').classList.remove('hidden');
        document.getElementById('venueModal').classList.add('flex');
    }

    function closeVenueModal() {
        document.getElementById('venueModal').classList.add('hidden');
        document.getElementById('venueModal').classList.remove('flex');
    }

    function editVenue(venue) {
        document.getElementById('venueModalTitle').textContent = 'Edit Venue';
        document.getElementById('venueId').value = venue.venue_id;
        document.getElementById('venueName').value = venue.venue_name;
        document.getElementById('venueAddress1').value = venue.address_line1;
        document.getElementById('venueAddress2').value = venue.address_line2 || '';
        document.getElementById('venueCity').value = venue.city;
        document.getElementById('venuePostalCode').value = venue.postal_code || '';
        document.getElementById('venueCountry').value = venue.country;
        document.getElementById('venueTotalCapacity').value = venue.total_capacity;
        document.getElementById('venuePhone').value = venue.phone || '';
        document.getElementById('venueFacilities').value = venue.facilities || '';
        
        document.getElementById('venueModal').classList.remove('hidden');
        document.getElementById('venueModal').classList.add('flex');
    }

    // Performance modals
    function openPerformanceModal() {
        document.getElementById('performanceModalTitle').textContent = 'Add Performance';
        document.getElementById('performanceForm').reset();
        document.getElementById('performanceId').value = '';
        loadShowsForPerformance();
        loadVenuesForPerformance();
        document.getElementById('performanceModal').classList.remove('hidden');
        document.getElementById('performanceModal').classList.add('flex');
    }

    function closePerformanceModal() {
        document.getElementById('performanceModal').classList.add('hidden');
        document.getElementById('performanceModal').classList.remove('flex');
    }

    function editPerformance(perf) {
        document.getElementById('performanceModalTitle').textContent = 'Edit Performance';
        document.getElementById('performanceId').value = perf.performance_id;
        document.getElementById('performanceDate').value = perf.performance_date;
        document.getElementById('performanceStartTime').value = perf.start_time;
        document.getElementById('performanceEndTime').value = perf.end_time || '';
        document.getElementById('performanceTotalSeats').value = perf.total_seats;
        document.getElementById('performanceAvailableSeats').value = perf.available_seats;
        document.getElementById('performanceStatus').value = perf.performance_status;
        document.getElementById('performanceNotes').value = perf.special_notes || '';
        
        Promise.all([loadShowsForPerformance(), loadVenuesForPerformance()]).then(() => {
            document.getElementById('performanceShow').value = perf.show_id;
            document.getElementById('performanceVenue').value = perf.venue_id;
        });
        
        document.getElementById('performanceModal').classList.remove('hidden');
        document.getElementById('performanceModal').classList.add('flex');
    }

    async function loadShowsForPerformance() {
        try {
            const response = await fetch('/api/shows/?status=Active');
            if (response.ok) {
                const shows = await response.json();
                const select = document.getElementById('performanceShow');
                select.innerHTML = shows.map(s => `<option value="${s.show_id}">${s.title}</option>`).join('');
            }
        } catch (error) {
            console.error('Error loading shows:', error);
        }
    }

    async function loadVenuesForPerformance() {
        try {
            const response = await fetch('/api/shows/venues/');
            if (response.ok) {
                const venues = await response.json();
                const select = document.getElementById('performanceVenue');
                select.innerHTML = venues.map(v => `<option value="${v.venue_id}">${v.venue_name}</option>`).join('');
            }
        } catch (error) {
            console.error('Error loading venues:', error);
        }
    }

    // Form submissions
    document.getElementById('showForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const token = localStorage.getItem('token');
        const showId = document.getElementById('showId').value;
        
        const data = {
            title: document.getElementById('showTitle').value,
            description: document.getElementById('showDescription').value || null,
            genre_id: parseInt(document.getElementById('showGenre').value),
            duration_minutes: parseInt(document.getElementById('showDuration').value),
            language: document.getElementById('showLanguage').value || null,
            age_rating: document.getElementById('showAgeRating').value || null,
            producer: document.getElementById('showProducer').value || null,
            director: document.getElementById('showDirector').value || null,
            poster_url: document.getElementById('showPosterUrl').value || null,
            show_status: document.getElementById('showStatus').value
        };
        
        try {
            const response = await fetch(showId ? `/api/admin/shows/${showId}` : '/api/admin/shows', {
                method: showId ? 'PUT' : 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(data)
            });
            
            if (response.ok) {
                closeShowModal();
                loadShows();
                loadStats();
                alert(showId ? 'Show updated successfully!' : 'Show created successfully!');
            } else {
                const error = await response.json();
                alert(error.detail || 'Failed to save show');
            }
        } catch (error) {
            console.error('Error saving show:', error);
            alert('Failed to save show');
        }
    });

    document.getElementById('venueForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const token = localStorage.getItem('token');
        const venueId = document.getElementById('venueId').value;
        
        const data = {
            venue_name: document.getElementById('venueName').value,
            address_line1: document.getElementById('venueAddress1').value,
            address_line2: document.getElementById('venueAddress2').value || null,
            city: document.getElementById('venueCity').value,
            postal_code: document.getElementById('venuePostalCode').value || null,
            country: document.getElementById('venueCountry').value,
            total_capacity: parseInt(document.getElementById('venueTotalCapacity').value),
            phone: document.getElementById('venuePhone').value || null,
            facilities: document.getElementById('venueFacilities').value || null
        };
        
        try {
            const response = await fetch(venueId ? `/api/admin/venues/${venueId}` : '/api/admin/venues', {
                method: venueId ? 'PUT' : 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(data)
            });
            
            if (response.ok) {
                closeVenueModal();
                loadVenues();
                loadStats();
                alert(venueId ? 'Venue updated successfully!' : 'Venue created successfully!');
            } else {
                const error = await response.json();
                alert(error.detail || 'Failed to save venue');
            }
        } catch (error) {
            console.error('Error saving venue:', error);
            alert('Failed to save venue');
        }
    });

    document.getElementById('performanceForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const token = localStorage.getItem('token');
        const performanceId = document.getElementById('performanceId').value;
        
        const data = {
            show_id: parseInt(document.getElementById('performanceShow').value),
            venue_id: parseInt(document.getElementById('performanceVenue').value),
            performance_date: document.getElementById('performanceDate').value,
            start_time: document.getElementById('performanceStartTime').value,
            end_time: document.getElementById('performanceEndTime').value || null,
            total_seats: parseInt(document.getElementById('performanceTotalSeats').value),
            available_seats: parseInt(document.getElementById('performanceAvailableSeats').value),
            performance_status: document.getElementById('performanceStatus').value,
            special_notes: document.getElementById('performanceNotes').value || null
        };
        
        try {
            const response = await fetch(performanceId ? `/api/admin/performances/${performanceId}` : '/api/admin/performances', {
                method: performanceId ? 'PUT' : 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(data)
            });
            
            if (response.ok) {
                closePerformanceModal();
                loadPerformances();
                loadStats();
                alert(performanceId ? 'Performance updated successfully!' : 'Performance created successfully!');
            } else {
                const error = await response.json();
                alert(error.detail || 'Failed to save performance');
            }
        } catch (error) {
            console.error('Error saving performance:', error);
            alert('Failed to save performance');
        }
    });

    // Delete functions
    async function deleteShow(showId) {
        if (!confirm('Are you sure you want to delete this show?')) return;
        
        const token = localStorage.getItem('token');
        
        try {
            const response = await fetch(`/api/admin/shows/${showId}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            if (response.ok) {
                loadShows();
                loadStats();
                alert('Show deleted successfully!');
            } else {
                const error = await response.json();
                alert(error.detail || 'Failed to delete show');
            }
        } catch (error) {
            console.error('Error deleting show:', error);
            alert('Failed to delete show');
        }
    }

    async function deleteVenue(venueId) {
        if (!confirm('Are you sure you want to delete this venue?')) return;
        
        const token = localStorage.getItem('token');
        
        try {
            const response = await fetch(`/api/admin/venues/${venueId}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            if (response.ok) {
                loadVenues();
                loadStats();
                alert('Venue deleted successfully!');
            } else {
                const error = await response.json();
                alert(error.detail || 'Failed to delete venue');
            }
        } catch (error) {
            console.error('Error deleting venue:', error);
            alert('Failed to delete venue');
        }
    }

    async function deletePerformance(performanceId) {
        if (!confirm('Are you sure you want to delete this performance?')) return;
        
        const token = localStorage.getItem('token');
        
        try {
            const response = await fetch(`/api/admin/performances/${performanceId}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            if (response.ok) {
                loadPerformances();
                loadStats();
                alert('Performance deleted successfully!');
            } else {
                const error = await response.json();
                alert(error.detail || 'Failed to delete performance');
            }
        } catch (error) {
            console.error('Error deleting performance:', error);
            alert('Failed to delete performance');
        }
    }

    // CSS for active tab
    const style = document.createElement('style');
    style.textContent = `
        .tab-btn.active {
            background: linear-gradient(to right, rgb(168, 85, 247), rgb(236, 72, 153));
            color: white;
        }
    `;
    document.head.appendChild(style);

    // Initialize
    if (checkAdminAccess()) {
        loadStats();
        loadShows();
    }
</script>
{% endblock %}
