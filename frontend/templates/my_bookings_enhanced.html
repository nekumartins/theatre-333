{% extends "base.html" %}

{% block title %}My Bookings{% endblock %}

{% block preauth %}
<script>
    (function() {
        function isTokenValid(token) {
            if (!token) return false;
            try {
                const payload = JSON.parse(atob(token.split('.')[1]));
                const exp = payload.exp * 1000;
                return Date.now() < exp;
            } catch (e) {
                return false;
            }
        }
        const token = localStorage.getItem('access_token');
        if (!token || !isTokenValid(token)) {
            localStorage.clear();
            window.location.href = '/login';
        }
    })();
</script>
{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <div class="flex justify-between items-center mb-8">
        <h1 class="text-4xl font-bold bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent">My Bookings</h1>
        <a href="/shows" class="px-6 py-2 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-lg font-medium hover:opacity-90 transition-opacity">
            + Book New Show
        </a>
    </div>
    
    <!-- Filter Tabs -->
    <div class="flex space-x-2 mb-6 bg-[#12121a] p-1 rounded-lg inline-flex">
        <button onclick="filterBookings('all')" class="filter-btn active px-4 py-2 rounded-md text-white transition-all">
            All
        </button>
        <button onclick="filterBookings('Confirmed')" class="filter-btn px-4 py-2 rounded-md text-gray-400 hover:text-white transition-all">
            Confirmed
        </button>
        <button onclick="filterBookings('Pending')" class="filter-btn px-4 py-2 rounded-md text-gray-400 hover:text-white transition-all">
            Pending Payment
        </button>
        <button onclick="filterBookings('Cancelled')" class="filter-btn px-4 py-2 rounded-md text-gray-400 hover:text-white transition-all">
            Cancelled
        </button>
    </div>
    
    <div id="bookings-container">
        <div class="text-center text-gray-400">Loading your bookings...</div>
    </div>
    
    <!-- Refund Request Modal -->
    <div id="refund-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
        <div class="bg-[#12121a] rounded-xl border border-purple-500/20 p-8 max-w-md w-full mx-4">
            <h3 class="text-2xl font-bold text-white mb-4">Request Refund</h3>
            <p class="text-gray-400 mb-6">Are you sure you want to request a refund for this booking?</p>
            
            <div id="refund-details" class="bg-[#0a0a0f] p-4 rounded-lg mb-6">
                <!-- Booking details will be loaded here -->
            </div>
            
            <div class="mb-6">
                <label class="block text-gray-300 font-medium mb-2">Reason for Refund</label>
                <textarea id="refund-reason" rows="3" 
                          class="w-full bg-[#0a0a0f] border border-purple-500/30 rounded-lg px-4 py-3 text-gray-300 placeholder-gray-500 focus:border-purple-500 focus:outline-none focus:ring-2 focus:ring-purple-500/20"
                          placeholder="Please provide a reason for your refund request..."></textarea>
            </div>
            
            <div class="p-4 bg-yellow-500/10 border border-yellow-500/30 rounded-lg mb-6">
                <p class="text-yellow-400 text-sm">
                    <strong>Refund Policy:</strong> Full refunds are available up to 24 hours before the performance. 
                    After that, a 50% cancellation fee applies.
                </p>
            </div>
            
            <div class="flex space-x-4">
                <button onclick="closeRefundModal()" class="flex-1 px-4 py-3 bg-gray-700 text-white rounded-lg hover:bg-gray-600 transition-colors">
                    Cancel
                </button>
                <button onclick="submitRefundRequest()" class="flex-1 px-4 py-3 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors">
                    Request Refund
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    .filter-btn.active {
        background: linear-gradient(to right, rgb(168, 85, 247), rgb(236, 72, 153));
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    // Get token from localStorage
    const token = localStorage.getItem('access_token');
    let allBookings = [];
    let currentFilter = 'all';
    let selectedBookingId = null;
    
    function filterBookings(status) {
        currentFilter = status;
        
        // Update filter button states
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.classList.remove('active', 'text-white');
            btn.classList.add('text-gray-400');
        });
        event.target.classList.add('active', 'text-white');
        event.target.classList.remove('text-gray-400');
        
        renderBookings();
    }
    
    function renderBookings() {
        const container = document.getElementById('bookings-container');
        
        try {
            let filteredBookings = allBookings;
            if (currentFilter !== 'all') {
                filteredBookings = allBookings.filter(b => b.booking_status === currentFilter);
            }
            
            console.log('Rendering', filteredBookings.length, 'bookings with filter:', currentFilter);
            
            if (filteredBookings.length === 0) {
                container.innerHTML = `
                    <div class="bg-gradient-to-br from-[#12121a] to-[#1a1a24] rounded-xl border border-purple-500/20 p-12 text-center">
                        <div class="text-6xl mb-4">üé≠</div>
                        <p class="text-gray-400 mb-6 text-lg">
                            ${currentFilter === 'all' ? 'You have no bookings yet.' : `No ${currentFilter.toLowerCase()} bookings.`}
                        </p>
                        <a href="/shows" class="inline-block px-8 py-3 bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white rounded-lg font-medium transition-all shadow-lg shadow-purple-500/30">
                            Browse Shows
                        </a>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = filteredBookings.map(booking => {
                const seats = booking.booking_details?.map(d => `${d.row_number}${d.seat_number}`).join(', ') || 'N/A';
                
                const statusBadges = {
                    'Confirmed': 'bg-green-500/10 text-green-400 border-green-500/20',
                    'Pending': 'bg-yellow-500/10 text-yellow-400 border-yellow-500/20',
                    'Cancelled': 'bg-red-500/10 text-red-400 border-red-500/20'
                };
                const statusBadge = statusBadges[booking.booking_status] || 'bg-gray-500/10 text-gray-400 border-gray-500/20';
                
                const perfDate = booking.performance ? new Date(booking.performance.performance_date) : null;
                const isUpcoming = perfDate ? perfDate > new Date() : false;
                const canCancel = isUpcoming && booking.booking_status !== 'Cancelled';
                const canRefund = booking.booking_status === 'Confirmed' && isUpcoming;
                
                // Check if within 24 hours (cancellation window)
            const hoursUntilShow = perfDate ? (perfDate - new Date()) / (1000 * 60 * 60) : 0;
            const withinCancellationWindow = hoursUntilShow > 24;
            
            return `
                <div class="bg-gradient-to-br from-[#12121a] to-[#1a1a24] rounded-xl border border-purple-500/20 hover:border-purple-500/40 transition-all p-6 mb-4">
                    <div class="flex flex-col lg:flex-row justify-between gap-6">
                        <div class="flex-1">
                            <div class="flex items-start justify-between mb-3">
                                <h3 class="text-2xl font-bold text-white">
                                    ${booking.performance?.show?.title || 'Unknown Show'}
                                </h3>
                                <span class="inline-block px-3 py-1 rounded-lg text-sm font-semibold border ${statusBadge}">
                                    ${booking.booking_status}
                                </span>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-gray-300">
                                <div class="flex items-center">
                                    <span class="text-purple-400 mr-2">üìÖ</span>
                                    <span>${booking.performance?.performance_date ? new Date(booking.performance.performance_date).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' }) : 'N/A'}</span>
                                </div>
                                <div class="flex items-center">
                                    <span class="text-purple-400 mr-2">üïê</span>
                                    <span>${booking.performance?.start_time || 'N/A'}</span>
                                </div>
                                <div class="flex items-center">
                                    <span class="text-purple-400 mr-2">üìç</span>
                                    <span>${booking.performance?.venue?.venue_name || 'N/A'}</span>
                                </div>
                                <div class="flex items-center">
                                    <span class="text-purple-400 mr-2">üí∫</span>
                                    <span>${seats}</span>
                                </div>
                            </div>
                            
                            <div class="mt-4 flex items-center">
                                <span class="text-purple-400 mr-2">üîñ</span>
                                <code class="bg-purple-500/10 px-3 py-1 rounded text-purple-300 font-mono">${booking.booking_reference}</code>
                            </div>
                            
                            <p class="text-sm text-gray-500 mt-3">
                                Booked: ${new Date(booking.booking_date).toLocaleString()}
                            </p>
                        </div>
                        
                        <div class="flex flex-col items-end justify-between lg:w-56">
                            <div class="text-right w-full">
                                <p class="text-3xl font-bold bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent">
                                    $${parseFloat(booking.total_amount).toFixed(2)}
                                </p>
                            </div>
                            
                            <div class="space-y-2 w-full mt-4">
                                ${booking.booking_status === 'Confirmed' ? `
                                    <a href="/booking/${booking.booking_id}/ticket" 
                                       class="block text-center px-4 py-2 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-lg font-medium hover:opacity-90 transition-opacity">
                                        üé´ View Ticket
                                    </a>
                                ` : ''}
                                
                                ${booking.booking_status === 'Pending' ? `
                                    <a href="/booking/${booking.booking_id}/payment" 
                                       class="block text-center px-4 py-2 bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 text-white rounded-lg font-medium transition-all shadow-lg shadow-green-500/20">
                                        üí≥ Complete Payment
                                    </a>
                                ` : ''}
                                
                                ${canRefund && withinCancellationWindow ? `
                                    <button onclick="openRefundModal(${booking.booking_id}, '${booking.booking_reference}', ${booking.total_amount})" 
                                            class="block w-full px-4 py-2 bg-orange-500/10 hover:bg-orange-500/20 text-orange-400 rounded-lg font-medium transition-all border border-orange-500/20">
                                        üí∞ Request Refund
                                    </button>
                                ` : ''}
                                
                                ${canCancel && booking.booking_status === 'Pending' ? `
                                    <button onclick="cancelBooking(${booking.booking_id})" 
                                            class="block w-full px-4 py-2 bg-red-500/10 hover:bg-red-500/20 text-red-400 rounded-lg font-medium transition-all border border-red-500/20">
                                        ‚úï Cancel Booking
                                    </button>
                                ` : ''}
                                
                                ${!isUpcoming && booking.booking_status === 'Confirmed' ? `
                                    <span class="block text-center text-gray-500 text-sm py-2">
                                        Event completed
                                    </span>
                                ` : ''}
                                
                                ${!withinCancellationWindow && booking.booking_status === 'Confirmed' && isUpcoming ? `
                                    <span class="block text-center text-yellow-500 text-sm py-2">
                                        ‚ö†Ô∏è Within 24hr - No refund
                                    </span>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            }).join('');
        } catch (error) {
            console.error('Error rendering bookings:', error);
            container.innerHTML = `<p class="text-pink-400 text-center">Error displaying bookings: ${error.message}</p>`;
        }
    }

    async function loadBookings() {
        const container = document.getElementById('bookings-container');
        try {
            // Decode JWT payload
            const payload = JSON.parse(atob(token.split('.')[1]));
            console.log('JWT payload:', payload);
            
            // Get user_id from token (check multiple possible field names)
            const userId = payload.user_id || payload.userId || payload.sub_id || 1;
            console.log('Using user_id:', userId);
        
            const response = await fetch(`/api/bookings/user/${userId}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            console.log('Response status:', response.status);
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            console.log('Raw API response:', data);
            
            allBookings = Array.isArray(data) ? data : [];
            console.log('Loaded bookings count:', allBookings.length);
            
            if (allBookings.length === 0) {
                container.innerHTML = `
                    <div class="bg-gradient-to-br from-[#12121a] to-[#1a1a24] rounded-xl border border-purple-500/20 p-12 text-center">
                        <div class="text-6xl mb-4">üé≠</div>
                        <p class="text-gray-400 mb-6 text-lg">You have no bookings yet.</p>
                        <a href="/shows" class="inline-block px-8 py-3 bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white rounded-lg font-medium transition-all shadow-lg shadow-purple-500/30">
                            Browse Shows
                        </a>
                    </div>
                `;
                return;
            }
            
            renderBookings();
        } catch (error) {
            console.error('Error loading bookings:', error);
            container.innerHTML = 
                `<p class="text-pink-400 text-center">Error loading bookings: ${error.message}. Please try logging in again.</p>`;
        }
    }
    
    async function cancelBooking(bookingId) {
        if (!confirm('Are you sure you want to cancel this booking? Your seats will be released.')) {
            return;
        }
        
        try {
            const response = await fetch(`/api/bookings/${bookingId}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            const data = await response.json();
            
            if (response.ok) {
                alert('Booking cancelled successfully!');
                loadBookings();
            } else {
                alert('Error cancelling booking: ' + (data.detail || 'Unknown error'));
            }
        } catch (error) {
            console.error('Error cancelling booking:', error);
            alert('Error cancelling booking. Please try again.');
        }
    }
    
    function openRefundModal(bookingId, reference, amount) {
        selectedBookingId = bookingId;
        
        document.getElementById('refund-details').innerHTML = `
            <div class="flex justify-between text-gray-400 mb-2">
                <span>Booking Reference:</span>
                <span class="text-white font-mono">${reference}</span>
            </div>
            <div class="flex justify-between text-gray-400">
                <span>Refund Amount:</span>
                <span class="text-green-400 font-semibold">$${parseFloat(amount).toFixed(2)}</span>
            </div>
        `;
        
        document.getElementById('refund-modal').classList.remove('hidden');
        document.getElementById('refund-modal').classList.add('flex');
    }
    
    function closeRefundModal() {
        document.getElementById('refund-modal').classList.add('hidden');
        document.getElementById('refund-modal').classList.remove('flex');
        selectedBookingId = null;
        document.getElementById('refund-reason').value = '';
    }
    
    async function submitRefundRequest() {
        if (!selectedBookingId) return;
        
        const reason = document.getElementById('refund-reason').value.trim();
        if (!reason) {
            alert('Please provide a reason for your refund request.');
            return;
        }
        
        try {
            const response = await fetch(`/api/bookings/${selectedBookingId}/refund`, {
                method: 'POST',
                headers: { 
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ reason })
            });
            
            const data = await response.json();
            
            if (response.ok) {
                alert('Refund request submitted successfully! You will receive a confirmation email shortly.');
                closeRefundModal();
                loadBookings();
            } else {
                alert('Error submitting refund request: ' + (data.detail || 'Unknown error'));
            }
        } catch (error) {
            console.error('Error submitting refund:', error);
            alert('Error submitting refund request. Please try again.');
        }
    }
    
    // Close modal when clicking outside
    document.getElementById('refund-modal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeRefundModal();
        }
    });
    
    loadBookings();
</script>
{% endblock %}
