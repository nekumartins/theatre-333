{% extends "base.html" %}

{% block title %}Complete Payment{% endblock %}

{% block preauth %}
<script>
    (function() {
        function isTokenValid(token) {
            if (!token) return false;
            try {
                const payload = JSON.parse(atob(token.split('.')[1]));
                const exp = payload.exp * 1000;
                return Date.now() < exp;
            } catch (e) {
                return false;
            }
        }
        const token = localStorage.getItem('access_token');
        if (!token || !isTokenValid(token)) {
            localStorage.clear();
            window.location.href = '/login';
        }
    })();
</script>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-[#0a0a0f] py-12">
    <div class="max-w-4xl mx-auto px-4">
        <h1 class="text-4xl font-bold mb-8 bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent text-center">
            Complete Your Payment
        </h1>
        
        <!-- Payment Deadline Warning -->
        <div id="deadline-warning" class="mb-6 p-4 bg-yellow-500/10 border border-yellow-500/30 rounded-lg flex items-center justify-between">
            <div class="flex items-center">
                <span class="text-2xl mr-3">‚è∞</span>
                <div>
                    <p class="text-yellow-400 font-semibold">Complete payment before your reservation expires!</p>
                    <p class="text-gray-400 text-sm">Seats will be released if payment is not completed in time.</p>
                </div>
            </div>
            <div id="countdown" class="text-3xl font-mono font-bold text-yellow-400">
                --:--
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Booking Summary -->
            <div class="bg-gradient-to-br from-[#12121a] to-[#1a1a24] rounded-xl border border-purple-500/20 p-6">
                <h2 class="text-2xl font-bold text-white mb-6">üìã Booking Summary</h2>
                
                <div id="booking-details" class="space-y-4">
                    <div class="text-center text-gray-500">Loading booking details...</div>
                </div>
                
                <!-- Price Breakdown -->
                <div class="border-t border-purple-500/20 mt-6 pt-6">
                    <h3 class="text-lg font-semibold text-white mb-4">Price Breakdown</h3>
                    <div id="price-breakdown" class="space-y-2">
                        <!-- Will be populated -->
                    </div>
                    <div class="border-t border-purple-500/20 mt-4 pt-4">
                        <div class="flex justify-between text-xl font-bold">
                            <span class="text-white">Total</span>
                            <span id="total-amount" class="bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent">$0.00</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Payment Form -->
            <div class="bg-gradient-to-br from-[#12121a] to-[#1a1a24] rounded-xl border border-purple-500/20 p-6">
                <h2 class="text-2xl font-bold text-white mb-6">üí≥ Payment Details</h2>
                
                <!-- Payment Method Selector -->
                <div class="mb-6">
                    <label class="block text-gray-300 font-medium mb-3">Select Payment Method</label>
                    <div class="grid grid-cols-3 gap-3">
                        <button type="button" onclick="selectPaymentMethod('Credit Card')" 
                                class="payment-method-btn active p-4 bg-[#0a0a0f] border-2 border-purple-500 rounded-lg text-center transition-all">
                            <span class="text-2xl block mb-1">üí≥</span>
                            <span class="text-white text-sm">Credit Card</span>
                        </button>
                        <button type="button" onclick="selectPaymentMethod('Debit Card')" 
                                class="payment-method-btn p-4 bg-[#0a0a0f] border-2 border-gray-700 rounded-lg text-center transition-all hover:border-purple-500/50">
                            <span class="text-2xl block mb-1">üí≥</span>
                            <span class="text-gray-400 text-sm">Debit Card</span>
                        </button>
                        <button type="button" onclick="selectPaymentMethod('PayPal')" 
                                class="payment-method-btn p-4 bg-[#0a0a0f] border-2 border-gray-700 rounded-lg text-center transition-all hover:border-purple-500/50">
                            <span class="text-2xl block mb-1">üÖøÔ∏è</span>
                            <span class="text-gray-400 text-sm">PayPal</span>
                        </button>
                        <button type="button" onclick="selectPaymentMethod('Apple Pay')" 
                                class="payment-method-btn p-4 bg-[#0a0a0f] border-2 border-gray-700 rounded-lg text-center transition-all hover:border-purple-500/50">
                            <span class="text-2xl block mb-1">üçé</span>
                            <span class="text-gray-400 text-sm">Apple Pay</span>
                        </button>
                        <button type="button" onclick="selectPaymentMethod('Google Pay')" 
                                class="payment-method-btn p-4 bg-[#0a0a0f] border-2 border-gray-700 rounded-lg text-center transition-all hover:border-purple-500/50">
                            <span class="text-2xl block mb-1">üîµ</span>
                            <span class="text-gray-400 text-sm">Google Pay</span>
                        </button>
                        <button type="button" onclick="selectPaymentMethod('Digital Wallet')" 
                                class="payment-method-btn p-4 bg-[#0a0a0f] border-2 border-gray-700 rounded-lg text-center transition-all hover:border-purple-500/50">
                            <span class="text-2xl block mb-1">üì±</span>
                            <span class="text-gray-400 text-sm">Digital Wallet</span>
                        </button>
                    </div>
                </div>

                <form id="payment-form" class="space-y-4">
                    <input type="hidden" id="payment-method" value="Credit Card">
                    
                    <!-- Card Details Section -->
                    <div id="card-details-section">
                        <div>
                            <label class="block text-gray-300 font-medium mb-2">Card Number</label>
                            <input type="text" id="card-number" 
                                   class="w-full bg-[#0a0a0f] border border-purple-500/30 rounded-lg px-4 py-3 text-gray-300 placeholder-gray-500 focus:border-purple-500 focus:outline-none focus:ring-2 focus:ring-purple-500/20" 
                                   placeholder="1234 5678 9012 3456"
                                   maxlength="19"
                                   required>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4 mt-4">
                            <div>
                                <label class="block text-gray-300 font-medium mb-2">Expiry Date</label>
                                <input type="text" id="expiry-date" 
                                       class="w-full bg-[#0a0a0f] border border-purple-500/30 rounded-lg px-4 py-3 text-gray-300 placeholder-gray-500 focus:border-purple-500 focus:outline-none focus:ring-2 focus:ring-purple-500/20" 
                                       placeholder="MM/YY"
                                       maxlength="5"
                                       required>
                            </div>
                            <div>
                                <label class="block text-gray-300 font-medium mb-2">CVV</label>
                                <input type="text" id="cvv" 
                                       class="w-full bg-[#0a0a0f] border border-purple-500/30 rounded-lg px-4 py-3 text-gray-300 placeholder-gray-500 focus:border-purple-500 focus:outline-none focus:ring-2 focus:ring-purple-500/20" 
                                       placeholder="123"
                                       maxlength="4"
                                       required>
                            </div>
                        </div>
                        
                        <div class="mt-4">
                            <label class="block text-gray-300 font-medium mb-2">Cardholder Name</label>
                            <input type="text" id="cardholder-name" 
                                   class="w-full bg-[#0a0a0f] border border-purple-500/30 rounded-lg px-4 py-3 text-gray-300 placeholder-gray-500 focus:border-purple-500 focus:outline-none focus:ring-2 focus:ring-purple-500/20" 
                                   placeholder="John Doe"
                                   required>
                        </div>
                    </div>

                    <!-- Digital Payment Section (hidden by default) -->
                    <div id="digital-payment-section" class="hidden">
                        <div class="text-center p-8 bg-[#0a0a0f] rounded-lg border border-purple-500/20">
                            <p id="digital-payment-message" class="text-gray-400 mb-4">
                                Click the button below to complete payment with your digital wallet
                            </p>
                            <div id="digital-payment-icon" class="text-6xl mb-4">üì±</div>
                        </div>
                    </div>
                    
                    <!-- Security Info -->
                    <div class="flex items-center text-gray-500 text-sm mt-4">
                        <span class="mr-2">üîí</span>
                        <span>Your payment is secured with 256-bit SSL encryption</span>
                    </div>
                    
                    <div class="pt-6">
                        <button type="submit" id="pay-btn"
                                class="w-full bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 text-white py-4 rounded-lg font-bold text-lg transition-all shadow-lg shadow-green-500/30 hover:shadow-green-500/50 disabled:opacity-50 disabled:cursor-not-allowed">
                            <span id="pay-btn-text">Pay Now - $0.00</span>
                        </button>
                    </div>
                </form>

                <!-- Cancel Link -->
                <p class="text-center mt-4 text-gray-500 text-sm">
                    Changed your mind? 
                    <a href="/my-bookings" class="text-red-400 hover:text-red-300">Cancel booking</a>
                </p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Get booking ID from URL
    const pathParts = window.location.pathname.split('/');
    const bookingId = parseInt(pathParts[2]);
    let bookingAmount = 0;
    let paymentDeadline = null;
    let countdownInterval = null;
    let selectedPaymentMethod = 'Credit Card';
    
    function selectPaymentMethod(method) {
        selectedPaymentMethod = method;
        document.getElementById('payment-method').value = method;
        
        // Update UI
        document.querySelectorAll('.payment-method-btn').forEach(btn => {
            btn.classList.remove('active', 'border-purple-500');
            btn.classList.add('border-gray-700');
            btn.querySelector('span:last-child').classList.remove('text-white');
            btn.querySelector('span:last-child').classList.add('text-gray-400');
        });
        
        event.target.closest('.payment-method-btn').classList.add('active', 'border-purple-500');
        event.target.closest('.payment-method-btn').classList.remove('border-gray-700');
        event.target.closest('.payment-method-btn').querySelector('span:last-child').classList.add('text-white');
        event.target.closest('.payment-method-btn').querySelector('span:last-child').classList.remove('text-gray-400');
        
        // Show/hide card details based on method
        const cardSection = document.getElementById('card-details-section');
        const digitalSection = document.getElementById('digital-payment-section');
        const digitalIcon = document.getElementById('digital-payment-icon');
        const digitalMessage = document.getElementById('digital-payment-message');
        
        if (method === 'Credit Card' || method === 'Debit Card') {
            cardSection.classList.remove('hidden');
            digitalSection.classList.add('hidden');
        } else {
            cardSection.classList.add('hidden');
            digitalSection.classList.remove('hidden');
            
            // Update digital payment section
            if (method === 'PayPal') {
                digitalIcon.textContent = 'üÖøÔ∏è';
                digitalMessage.textContent = 'You will be redirected to PayPal to complete your payment';
            } else if (method === 'Apple Pay') {
                digitalIcon.textContent = 'üçé';
                digitalMessage.textContent = 'Complete payment with Apple Pay';
            } else if (method === 'Google Pay') {
                digitalIcon.textContent = 'üîµ';
                digitalMessage.textContent = 'Complete payment with Google Pay';
            } else {
                digitalIcon.textContent = 'üì±';
                digitalMessage.textContent = 'Complete payment with your digital wallet';
            }
        }
    }
    
    async function loadBookingDetails() {
        try {
            const response = await fetch(`/api/bookings/${bookingId}`);
            const booking = await response.json();
            
            if (booking.booking_status === 'Confirmed') {
                alert('This booking has already been paid!');
                window.location.href = '/my-bookings';
                return;
            }
            
            if (booking.booking_status === 'Cancelled') {
                alert('This booking has been cancelled');
                window.location.href = '/my-bookings';
                return;
            }
            
            bookingAmount = parseFloat(booking.total_amount);
            
            // Set payment deadline (from booking or default 15 min)
            if (booking.payment_deadline) {
                // Handle the datetime string properly
                // Backend sends ISO format datetime - parse it correctly
                let deadlineStr = booking.payment_deadline;
                // If no timezone indicator, treat as local time (backend uses datetime.now())
                if (!deadlineStr.includes('Z') && !deadlineStr.includes('+')) {
                    // Replace space with T for proper ISO parsing if needed
                    deadlineStr = deadlineStr.replace(' ', 'T');
                }
                paymentDeadline = new Date(deadlineStr);
                
                // If the parsed date is invalid or seems wrong, use fallback
                if (isNaN(paymentDeadline.getTime())) {
                    paymentDeadline = new Date(Date.now() + 15 * 60 * 1000);
                }
            } else {
                // Fallback: 15 minutes from now
                paymentDeadline = new Date(Date.now() + 15 * 60 * 1000);
            }
            
            // Start countdown
            updateCountdown();
            countdownInterval = setInterval(updateCountdown, 1000);
            
            const seats = booking.booking_details.map(d => `Row ${d.row_number} Seat ${d.seat_number}`).join(', ');
            
            document.getElementById('booking-details').innerHTML = `
                <div class="space-y-4">
                    <div class="flex justify-between">
                        <span class="text-gray-400">Reference</span>
                        <span class="text-white font-mono font-semibold">${booking.booking_reference}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Show</span>
                        <span class="text-white font-semibold">${booking.performance ? booking.performance.show.title : 'N/A'}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Date</span>
                        <span class="text-white">${booking.performance ? new Date(booking.performance.performance_date).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }) : 'N/A'}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Time</span>
                        <span class="text-white">${booking.performance ? booking.performance.start_time : 'N/A'}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Venue</span>
                        <span class="text-white">${booking.performance && booking.performance.venue ? booking.performance.venue.venue_name : 'N/A'}</span>
                    </div>
                    <div>
                        <span class="text-gray-400">Seats</span>
                        <div class="mt-2 flex flex-wrap gap-2">
                            ${booking.booking_details.map(d => `
                                <span class="px-3 py-1 bg-purple-500/20 text-purple-400 rounded-lg text-sm">
                                    ${d.row_number}${d.seat_number}
                                </span>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
            
            // Price breakdown
            document.getElementById('price-breakdown').innerHTML = booking.booking_details.map(d => `
                <div class="flex justify-between text-gray-400">
                    <span>Seat ${d.row_number}${d.seat_number}</span>
                    <span>$${parseFloat(d.seat_price).toFixed(2)}</span>
                </div>
            `).join('');
            
            document.getElementById('total-amount').textContent = `$${bookingAmount.toFixed(2)}`;
            document.getElementById('pay-btn-text').textContent = `Pay Now - $${bookingAmount.toFixed(2)}`;
            
        } catch (error) {
            console.error('Error loading booking:', error);
            document.getElementById('booking-details').innerHTML = 
                '<p class="text-red-400">Error loading booking details.</p>';
        }
    }
    
    function updateCountdown() {
        if (!paymentDeadline) return;
        
        const now = new Date();
        const diff = paymentDeadline - now;
        
        if (diff <= 0) {
            clearInterval(countdownInterval);
            document.getElementById('countdown').textContent = 'EXPIRED';
            document.getElementById('countdown').classList.remove('text-yellow-400');
            document.getElementById('countdown').classList.add('text-red-500');
            document.getElementById('pay-btn').disabled = true;
            
            // Show expiration warning
            document.getElementById('deadline-warning').innerHTML = `
                <div class="flex items-center text-red-400">
                    <span class="text-2xl mr-3">‚ö†Ô∏è</span>
                    <div>
                        <p class="font-semibold">Reservation Expired</p>
                        <p class="text-gray-400 text-sm">Your seats have been released. Please make a new booking.</p>
                    </div>
                </div>
            `;
            document.getElementById('deadline-warning').classList.remove('border-yellow-500/30', 'bg-yellow-500/10');
            document.getElementById('deadline-warning').classList.add('border-red-500/30', 'bg-red-500/10');
            return;
        }
        
        const minutes = Math.floor(diff / 60000);
        const seconds = Math.floor((diff % 60000) / 1000);
        document.getElementById('countdown').textContent = 
            `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        
        // Change color when less than 5 minutes
        if (minutes < 5) {
            document.getElementById('countdown').classList.remove('text-yellow-400');
            document.getElementById('countdown').classList.add('text-red-500');
        }
    }
    
    document.getElementById('payment-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const payBtn = document.getElementById('pay-btn');
        const originalText = payBtn.innerHTML;
        payBtn.innerHTML = '<span class="animate-pulse">Processing...</span>';
        payBtn.disabled = true;
        
        const cardNumber = document.getElementById('card-number').value;
        const cardLast4 = cardNumber.replace(/\s/g, '').slice(-4);
        
        try {
            const response = await fetch('/api/payments/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    booking_id: bookingId,
                    payment_amount: bookingAmount,
                    payment_method: selectedPaymentMethod,
                    card_last_four: (selectedPaymentMethod === 'Credit Card' || selectedPaymentMethod === 'Debit Card') ? cardLast4 : null
                })
            });
            
            const data = await response.json();
            
            if (response.ok) {
                clearInterval(countdownInterval);
                
                // Show success animation
                payBtn.innerHTML = '‚úì Payment Successful!';
                payBtn.classList.remove('from-green-500', 'to-emerald-500');
                payBtn.classList.add('from-purple-500', 'to-pink-500');
                
                // Redirect to ticket page
                setTimeout(() => {
                    window.location.href = `/booking/${bookingId}/ticket`;
                }, 1500);
            } else {
                payBtn.innerHTML = originalText;
                payBtn.disabled = false;
                alert('Payment failed: ' + (data.detail || data.message || 'Unknown error'));
            }
        } catch (error) {
            console.error('Error processing payment:', error);
            payBtn.innerHTML = originalText;
            payBtn.disabled = false;
            alert('Error processing payment. Please try again.');
        }
    });
    
    // Input formatting
    document.getElementById('card-number').addEventListener('input', function(e) {
        let value = e.target.value.replace(/\s/g, '').replace(/\D/g, '');
        let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
        e.target.value = formattedValue;
    });
    
    document.getElementById('expiry-date').addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        if (value.length >= 2) {
            value = value.slice(0, 2) + '/' + value.slice(2, 4);
        }
        e.target.value = value;
    });
    
    document.getElementById('cvv').addEventListener('input', function(e) {
        e.target.value = e.target.value.replace(/\D/g, '');
    });
    
    loadBookingDetails();
</script>
{% endblock %}
